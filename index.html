<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Greece Official Disaster Map</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<style>
  :root{
    --bg:#0f172a;--panel:#0b1222;--text:#e2e8f0;--muted:#94a3b8;--green:#22c55e;--red:#ef4444;--yellow:#f59e0b;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";}
  #app{display:grid;grid-template-columns:280px 1fr;height:100%;}
  #sidebar{background:var(--panel);padding:12px 12px 16px;border-right:1px solid #111827;overflow:auto}
  .h{font-weight:700;font-size:16px;margin:0 0 4px}
  .muted{color:var(--muted)}
  .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin:8px 0 6px}
  .card{background:#0d182f;border:1px solid #0f213f;border-radius:10px;padding:10px}
  .big{font-size:22px;font-weight:800}
  .row{display:flex;align-items:center;gap:8px;margin:8px 0}
  .row > label{min-width:0;flex:1}
  select,button{background:#0b1a33;border:1px solid #1e3a8a;color:var(--text);border-radius:8px;padding:6px 8px}
  button{cursor:pointer}
  .legend{display:flex;gap:10px;align-items:center;margin:8px 0}
  .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
  #map{height:100%;width:100%}
  .srcs{margin-top:10px;font-size:12px}
  .status{display:flex;gap:10px;margin:6px 0}
  .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #1f2937}
  .ok{background:#062314;color:#8ef0b2;border-color:#14532d}
  .err{background:#290909;color:#ffb4b4;border-color:#7f1d1d}
</style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1 class="h">Greece Official Disaster Map</h1>
    <div class="muted" style="margin-bottom:8px">Live earthquakes and fires in Greece. Data refreshes automatically every 10 minutes.</div>

    <div class="cards">
      <div class="card"><div class="muted">Earthquakes</div><div id="statQuakes" class="big">0</div></div>
      <div class="card"><div class="muted">Fires</div><div id="statFires" class="big">0</div></div>
      <div class="card"><div class="muted">Total</div><div id="statTotal" class="big">0</div></div>
      <div class="card"><div class="muted">Last updated</div><div id="lastUpdated">—</div></div>
    </div>

    <div class="h" style="margin-top:6px">Filters</div>
    <div class="row">
      <label><input type="checkbox" id="toggleQuakes" checked /> Earthquakes</label>
      <label><input type="checkbox" id="toggleFires" checked /> Fires</label>
    </div>
    <div class="row">
      <select id="timeRange" title="Time period">
        <option value="1">24h</option>
        <option value="3">3 days</option>
        <option value="7" selected>7 days</option>
        <option value="30">30 days</option>
        <option value="90">3 months</option>
        <option value="365">Last year</option>
      </select>
      <select id="minMag" title="Minimum magnitude">
        <option value="2">M 2+</option>
        <option value="3" selected>M 3+</option>
        <option value="4">M 4+</option>
        <option value="5">M 5+</option>
      </select>
      <button id="btnRefresh">Refresh</button>
    </div>

    <div class="h" style="margin-top:6px">API status</div>
    <div class="status">
      <span id="stEQ" class="pill">Earthquakes API</span>
      <span id="stFI" class="pill">Fires API</span>
    </div>

    <div class="srcs muted">
      <b>Data Sources</b>
      <ul>
        <li>Earthquakes: USGS, EMSC (SeismicPortal)</li>
        <li>Fires: NASA FIRMS (VIIRS SNPP/NOAA-20, MODIS)</li>
      </ul>
      © Live, client-side map. Built with Leaflet.
    </div>
  </aside>
  <div id="map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
/* =========================
   CONFIG — your Worker base
   ========================= */
const API_BASE = "https://greece-disasters.odysseas-3d2.workers.dev/api";

/* ====== MAP ====== */
const greeceBounds = [[34.8,19.3],[41.8,29.6]];
const map = L.map('map',{zoomControl:true}).fitBounds(greeceBounds);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

const quakeLayer = L.layerGroup().addTo(map);
const fireLayer  = L.layerGroup().addTo(map);

/* ====== UI HOOKS ====== */
const els = {
  statQuakes: document.getElementById('statQuakes'),
  statFires:  document.getElementById('statFires'),
  statTotal:  document.getElementById('statTotal'),
  lastUpdated:document.getElementById('lastUpdated'),
  timeRange:  document.getElementById('timeRange'),
  minMag:     document.getElementById('minMag'),
  btnRefresh: document.getElementById('btnRefresh'),
  tQuakes:    document.getElementById('toggleQuakes'),
  tFires:     document.getElementById('toggleFires'),
  stEQ:       document.getElementById('stEQ'),
  stFI:       document.getElementById('stFI'),
};

/* ====== UTILS ====== */
function setStatus(el, ok){
  el.className = 'pill ' + (ok ? 'ok' : 'err');
  el.textContent = el.id==='stEQ' ? 'Earthquakes API' : 'Fires API';
}
function fmtTime(ts){
  const d = new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}

/* ====== DRAWING ====== */
function quakeColor(m){
  if (m>=5) return '#ef4444';
  if (m>=4) return '#f59e0b';
  if (m>=3) return '#fde047';
  return '#a7f3d0';
}
function drawQuakes(list){
  quakeLayer.clearLayers();
  list.forEach(q=>{
    const r = Math.max(6, q.mag*3.5);
    const c = quakeColor(q.mag||0);
    const m = L.circleMarker([q.lat,q.lon],{
      radius:r, color:c, fillColor:c, fillOpacity:0.6, weight:1
    }).bindPopup(`
      <b>${(q.mag??'—').toFixed ? 'M '+q.mag.toFixed(1) : 'M '+q.mag}</b><br/>
      ${q.place || ''}<br/>
      <small>${new Date(q.time).toLocaleString()}</small><br/>
      <small>Sources: ${(q.sources||[]).join(', ')}</small>
    `);
    quakeLayer.addLayer(m);
  });
}
function drawFires(list){
  fireLayer.clearLayers();
  list.forEach(f=>{
    const c = f.verified ? '#ef4444' : '#fb7185'; // verified = darker
    const m = L.circleMarker([f.lat,f.lon],{
      radius:4, color:c, fillColor:c, fillOpacity:0.9, weight:0.5
    }).bindPopup(`
      <b>Fire (VIIRS/MODIS)</b><br/>
      Brightness: ${f.brightness ?? f.bright_ti4 ?? '—'}<br/>
      Confidence: ${f.confidence ?? '—'}<br/>
      <small>${new Date(f.time).toLocaleString()}</small><br/>
      <small>Sources: ${(f.sources||[]).join(', ')}</small>
    `);
    fireLayer.addLayer(m);
  });
}

/* ====== DATA FETCH ======
   IMPORTANT: time filter fix — we read the selected
   days from the <select> and pass ?days=<n> to both
   endpoints (and &minMag to earthquakes).
*/
async function fetchEarthquakes(days, minMag){
  const url = `${API_BASE}/earthquakes?days=${days}&minMag=${minMag}`;
  const res = await fetch(url, {cache:'no-store'});
  const json = await res.json();
  setStatus(els.stEQ, json.ok !== false);
  // Worker returns either {ok, data:[...]} or the list directly.
  if (json.data) return json.data.earthquakes || json.data || [];
  return json.earthquakes || json || [];
}

async function fetchFires(days){
  const url = `${API_BASE}/fires?days=${days}`;
  const res = await fetch(url, {cache:'no-store'});
  const json = await res.json();
  setStatus(els.stFI, json.ok !== false);
  if (json.data) return json.data;
  return json;
}

let autoTimer=null;
async function refresh(){
  const days   = parseInt(els.timeRange.value,10);        // <-- fixed: ensure numeric days
  const minMag = parseFloat(els.minMag.value);

  const [quakes, fires] = await Promise.all([
    els.tQuakes.checked ? fetchEarthquakes(days, minMag) : Promise.resolve([]),
    els.tFires.checked  ? fetchFires(days)               : Promise.resolve([]),
  ]);

  // Apply UI filters again client-side (safety)
  const qFiltered = quakes.filter(q => (q.mag ?? 0) >= minMag);

  drawQuakes(qFiltered);
  drawFires(fires);

  els.statQuakes.textContent = qFiltered.length.toString();
  els.statFires.textContent  = fires.length.toString();
  els.statTotal.textContent  = (qFiltered.length + fires.length).toString();
  els.lastUpdated.textContent = fmtTime(Date.now());
}

/* ====== EVENTS ====== */
['change','input'].forEach(ev=>{
  els.timeRange.addEventListener(ev, refresh);   // <-- fixed: changing time now refetches
  els.minMag.addEventListener(ev, refresh);
  els.tQuakes.addEventListener(ev, ()=>{
    quakeLayer.clearLayers();
    refresh();
  });
  els.tFires.addEventListener(ev, ()=>{
    fireLayer.clearLayers();
    refresh();
  });
});
els.btnRefresh.addEventListener('click', refresh);

/* ====== AUTO REFRESH (10 minutes) ====== */
function startAuto(){
  if (autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(refresh, 10*60*1000);
}

/* ====== BOOT ====== */
refresh();
startAuto();
</script>
</body>
</html>
