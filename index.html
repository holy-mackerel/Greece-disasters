<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greece Official Disaster Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0f1720;
      --panel:#131c26;
      --text:#e6edf3;
      --muted:#9db0c3;
      --accent:#4cc9f0;
      --ok:#22c55e;
      --err:#ef4444;
      --warn:#f59e0b;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu}
    #app{display:grid;grid-template-columns:340px 1fr;height:100%}

    /* sidebar */
    #sidebar{background:var(--panel);padding:14px 14px 18px;overflow:auto;border-right:1px solid #0b1118}
    h1{font-size:18px;margin:0 0 6px}
    .sub{color:var(--muted);margin-bottom:12px}
    .group{margin:12px 0 14px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .statgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .card{background:#0e1620;border:1px solid #0b1118;border-radius:10px;padding:10px}
    .k{font-size:22px;font-weight:700}
    .lbl{color:var(--muted);font-size:12px}
    .controls select,.controls button,.controls input[type="checkbox"]{accent-color:var(--accent)}
    select,button{background:#0e1620;border:1px solid #182532;color:var(--text);border-radius:8px;padding:8px}
    button{cursor:pointer}
    .bad{color:var(--err)}
    .good{color:var(--ok)}
    .note{font-size:12px;color:var(--muted)}
    .list{list-style:disc;margin:8px 0 0 18px;color:var(--muted);font-size:12px}
    .hr{height:1px;background:#0b1118;margin:12px 0}

    /* map */
    #map{height:100%;width:100%}
    .legend{position:absolute;bottom:12px;left:12px;background:#0e1620;color:#fff;padding:8px 10px;border-radius:8px;border:1px solid #0b1118;font-size:12px}
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1>Greece Official Disaster Map</h1>
    <div class="sub">Live earthquakes and fires in Greece. Data refreshes automatically every 10 minutes.</div>

    <div class="group">
      <div class="statgrid">
        <div class="card"><div class="k" id="kQuakes">0</div><div class="lbl">Earthquakes</div></div>
        <div class="card"><div class="k" id="kFires">0</div><div class="lbl">Fires</div></div>
        <div class="card"><div class="k" id="kTotal">0</div><div class="lbl">Total</div></div>
        <div class="card"><div class="k" id="kUpdated">—</div><div class="lbl">Last updated</div></div>
      </div>
    </div>

    <div class="group controls">
      <strong>Filters</strong>
      <div class="row" style="margin-top:6px">
        <label><input type="checkbox" id="showQuakes" checked> Earthquakes</label>
        <label><input type="checkbox" id="showFires" checked> Fires</label>
      </div>
      <div class="row" style="margin-top:6px">
        <select id="timeSel" title="Time period (applies to all)">
          <option value="1">24 hours</option>
          <option value="3">3 days</option>
          <option value="7" selected>7 days</option>
          <option value="30">30 days</option>
          <option value="90">3 months</option>
          <option value="365">Last year</option>
        </select>
        <select id="magSel" title="Minimum magnitude (earthquakes)">
          <option value="2">M 2+</option>
          <option value="3" selected>M 3+</option>
          <option value="4">M 4+</option>
          <option value="5">M 5+</option>
        </select>
        <button id="btnRefresh">Refresh</button>
      </div>
      <div id="msg" class="note" style="margin-top:6px"></div>
    </div>

    <div class="group">
      <div class="hr"></div>
      <strong>Data Sources</strong>
      <ul class="list">
        <li>Earthquakes: USGS, EMSC (SeismicPortal)</li>
        <li>Fires: NASA FIRMS (VIIRS SNPP/NOAA-20, MODIS)</li>
      </ul>
      <div class="note" style="margin-top:8px">© Live, client-side map. Built with Leaflet.</div>
    </div>
  </aside>

  <main id="map"></main>
</div>

<script>
  // ====== HARD-CODED API (Cloudflare Worker) ======
  // Your Worker base URL:
  const API_BASE = 'https://greece-disasters.odysseas-3d2.workers.dev';

  // ====== MAP SETUP ======
  const GREECE_BOUNDS = [[34.8,19.3],[41.8,29.6]];
  const map = L.map('map', { zoomControl: true, preferCanvas:true });
  map.fitBounds(GREECE_BOUNDS);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const quakeLayer = L.layerGroup().addTo(map);
  const fireLayer  = L.layerGroup().addTo(map);

  // ====== UI ELEMENTS ======
  const el = id => document.getElementById(id);
  const kQuakes = el('kQuakes'), kFires = el('kFires'), kTotal = el('kTotal'), kUpdated = el('kUpdated');
  const showQuakes = el('showQuakes'), showFires = el('showFires'), timeSel = el('timeSel'), magSel = el('magSel');
  const btnRefresh = el('btnRefresh'), msg = el('msg');

  // ====== HELPERS ======
  const fmtTime = ts => {
    try { return new Date(ts).toLocaleString(); } catch { return '—'; }
  };
  const colorForMag = m => {
    if (m>=6) return '#d73027';
    if (m>=5) return '#fc8d59';
    if (m>=4) return '#fee08b';
    if (m>=3) return '#d9ef8b';
    return '#91cf60';
  };
  const radiusForMag = m =>  Math.max(6, m*2.8 + 2);

  async function fetchJSON(url) {
    const r = await fetch(url, {mode:'cors'});
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  // Accept both shapes:
  // { ok:true, count:n, data:[...] }  OR  { ok:true, data:{ earthquakes:[...]} }
  function normalizeEarthquakes(json){
    if (!json) return [];
    if (Array.isArray(json.data)) return json.data;
    if (json.data && Array.isArray(json.data.earthquakes)) return json.data.earthquakes;
    if (json.earthquakes && Array.isArray(json.earthquakes)) return json.earthquakes;
    return [];
  }
  function normalizeFires(json){
    if (!json) return [];
    if (Array.isArray(json.data)) return json.data;
    if (json.data && Array.isArray(json.data.fires)) return json.data.fires;
    if (json.fires && Array.isArray(json.fires)) return json.fires;
    return [];
  }

  // ====== RENDERERS ======
  function drawEarthquakes(list){
    quakeLayer.clearLayers();
    if (!showQuakes.checked) return;

    list.forEach(ev=>{
      if (typeof ev.lat!=='number' || typeof ev.lon!=='number') return;
      const m = ev.mag ?? ev.magnitude ?? 0;
      const c = colorForMag(m);
      const r = radiusForMag(m);
      const t = ev.time ?? ev.timestamp ?? Date.now();

      const circ = L.circleMarker([ev.lat, ev.lon], {
        radius: r, color: c, fillColor: c, fillOpacity: 0.45, weight: 1.2
      });

      const place = ev.place || ev.region || '';
      const depth = (ev.depth!=null) ? `${ev.depth} km` : '—';
      const url = ev.url || ev.link || '';
      const srcs = Array.isArray(ev.sources) ? ev.sources.join(', ') : (ev._src || ev.source || '—');

      const html = `
        <b>Earthquake</b><br/>
        <b>M</b> ${m?.toFixed ? m.toFixed(1) : m} &nbsp; • &nbsp; <b>Depth</b> ${depth}<br/>
        <b>Time</b> ${fmtTime(t)}<br/>
        <b>Place</b> ${place}<br/>
        <b>Sources</b> ${srcs}${url ? `<br/><a href="${url}" target="_blank">details</a>`:''}
      `;
      circ.bindPopup(html);
      circ.addTo(quakeLayer);
    });
  }

  function drawFires(list){
    fireLayer.clearLayers();
    if (!showFires.checked) return;

    list.forEach(f=>{
      if (typeof f.lat!=='number' || typeof f.lon!=='number') return;
      const marker = L.circleMarker([f.lat, f.lon], {
        radius: 5, color: '#ff4444', fillColor: '#ff4444', fillOpacity: 0.6, weight: 0.8
      });
      const when = f.time ?? (f.acq_date && f.acq_time
        ? Date.parse(`${f.acq_date}T${String(f.acq_time).padStart(4,'0').slice(0,2)}:${String(f.acq_time).padStart(4,'0').slice(2)}:00Z`)
        : null);
      const conf = f.confidence ?? f.conf ?? '—';
      const srcs = Array.isArray(f.sources) ? f.sources.join(', ') : (f._src || 'FIRMS');

      const html = `
        <b>Active Fire (FIRMS)</b><br/>
        <b>Brightness</b> ${f.brightness ?? f.bright_ti4 ?? '—'}<br/>
        <b>Confidence</b> ${conf}<br/>
        <b>Time</b> ${when ? fmtTime(when) : '—'}<br/>
        <b>Sources</b> ${srcs}
      `;
      marker.bindPopup(html);
      marker.addTo(fireLayer);
    });
  }

  function updateStats(eq, fi){
    const qc = eq.length, fc = fi.length;
    kQuakes.textContent = qc;
    kFires.textContent  = fc;
    kTotal.textContent  = qc + fc;
    kUpdated.textContent = new Date().toLocaleTimeString();
  }

  // ====== LOAD ======
  async function loadAll(){
    const days   = Number(timeSel.value);
    const minmag = Number(magSel.value);

    // Endpoints expected by your Worker:
    //   GET /earthquakes?days=<1..365>&minmag=<2..5>
    //   GET /fires?days=<1..10>
    const eqURL = `${API_BASE}/earthquakes?days=${encodeURIComponent(days)}&minmag=${encodeURIComponent(minmag)}`;
    // FIRMS only allows up to 10 days; clamp:
    const firesDays = Math.min(days, 10);
    const fiURL = `${API_BASE}/fires?days=${encodeURIComponent(firesDays)}`;

    msg.textContent = 'Loading…';
    try{
      const [eqJson, fiJson] = await Promise.allSettled([
        fetchJSON(eqURL),
        fetchJSON(fiURL)
      ]);

      const earthquakes = eqJson.status==='fulfilled' ? normalizeEarthquakes(eqJson.value) : [];
      const fires       = fiJson.status==='fulfilled' ? normalizeFires(fiJson.value)       : [];

      drawEarthquakes(earthquakes);
      drawFires(fires);
      updateStats(earthquakes, fires);

      // Auto-fit if we have data
      const bounds = [];
      if (showQuakes.checked) earthquakes.forEach(e=>{ if(e.lat&&e.lon) bounds.push([e.lat,e.lon]); });
      if (showFires.checked)  fires.forEach(f=>{ if(f.lat&&f.lon) bounds.push([f.lat,f.lon]); });
      if (bounds.length){
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.15), { maxZoom: 9 });
      }else{
        map.fitBounds(GREECE_BOUNDS);
      }

      msg.textContent = '';
    }catch(err){
      console.error(err);
      msg.innerHTML = `<span class="bad">Error:</span> ${err.message || err}`;
      // keep previous layers if any
    }
  }

  // ====== EVENTS & AUTO REFRESH ======
  btnRefresh.addEventListener('click', loadAll);
  [showQuakes, showFires, timeSel, magSel].forEach(c=>{
    c.addEventListener('change', loadAll);
  });

  // Initial load + every 10 minutes
  loadAll();
  setInterval(loadAll, 10 * 60 * 1000);
</script>
</body>
</html>
