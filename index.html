<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greece Official Disaster Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet + PapaParse (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#121933; --accent:#00d1ff; --muted:#9fb0d9; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
    }
    html,body { height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; color:#e6ecff; background:var(--bg);}
    #app { display:grid; grid-template-columns: 360px 1fr; grid-template-rows: 100vh; }
    /* Sidebar */
    #sidebar {
      background: linear-gradient(180deg, #0b1020 0%, #0b1020cc 100%), radial-gradient(1200px 600px at -20% -10%, #1a2a6c33 0%, transparent 60%);
      border-right: 1px solid #1f2a49;
      padding: 16px 14px 14px 16px;
      overflow:auto;
    }
    .title { font-size:20px; font-weight:700; letter-spacing:.3px; }
    .subtitle { color: var(--muted); font-size:12px; margin-top:4px; line-height:1.4; }
    .panel {
      background: var(--card);
      border: 1px solid #1f2a49;
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .panel h3 { margin:0 0 8px 0; font-size:14px; letter-spacing:.2px; color:#cfe2ff; }
    .stats { display:grid; grid-template-columns: repeat(4,1fr); gap:8px; }
    .stat {
      background:#0f1533;
      border:1px solid #20305c;
      border-radius:12px; padding:8px; text-align:center;
    }
    .stat .num { font-weight:800; font-size:18px; }
    .stat .label { font-size:11px; color:var(--muted); }
    .sources { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .badge { display:flex; align-items:center; gap:8px; background:#0f1533; border:1px solid #20305c; border-radius:12px; padding:8px; font-size:12px; color:#cfe2ff;}
    .dot { width:10px; height:10px; border-radius:50%; background:#475569; box-shadow:0 0 0 2px #0b1020 inset;}
    .dot.ok{ background: var(--ok);}
    .dot.err{ background: var(--err);}
    .dot.warn{ background: var(--warn);}
    .controls { display:grid; gap:10px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .row .group { display:flex; align-items:center; gap:8px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      border:1px solid #28427a; background:#0f1533; color:#e6ecff; padding:10px 12px; border-radius:12px;
      font-weight:600; cursor:pointer;
    }
    .btn:hover { border-color:#3a60b8; }
    select, input[type="checkbox"] {
      background:#0f1533; color:#e6ecff; border:1px solid #28427a; padding:8px; border-radius:10px;
    }
    .small { font-size:12px; color:var(--muted); }
    /* Map */
    #map { width:100%; height:100vh; }
    .leaflet-popup-content { font-size:12px; }
    .legend { position:absolute; bottom:12px; right:12px; background:#0f1533; border:1px solid #20305c; color:#e6ecff; padding:8px 10px; border-radius:10px; font-size:12px; z-index:500; }
    .legend div { display:flex; align-items:center; gap:6px; margin:3px 0; }
    .key { width:10px; height:10px; border-radius:50%; }
    .key.eq { background:#ff6b00; }
    .key.fire { background:#ff2d55; }
    .key.flood { background:#3399ff; }
    .footer { margin-top:10px; font-size:11px; color:var(--muted); }
    a, a:visited { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
<div id="app">
  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="title">Greece Official Disaster Map</div>
    <div class="subtitle">Live earthquakes, fires, and floods across Greece. Data auto-refreshes every 10 minutes.</div>

    <div class="panel">
      <h3>Live Stats</h3>
      <div class="stats">
        <div class="stat"><div class="num" id="statEq">0</div><div class="label">Earthquakes</div></div>
        <div class="stat"><div class="num" id="statFire">0</div><div class="label">Fires</div></div>
        <div class="stat"><div class="num" id="statFlood">0</div><div class="label">Floods</div></div>
        <div class="stat"><div class="num" id="statTotal">0</div><div class="label">Total</div></div>
      </div>
    </div>

    <div class="panel">
      <h3>Source Status</h3>
      <div class="sources" id="sourceGrid">
        <!-- Earthquakes -->
        <div class="badge"><span class="dot" id="srcUSGS"></span>USGS</div>
        <div class="badge"><span class="dot" id="srcEMSC"></span>EMSC</div>
        <div class="badge"><span class="dot" id="srcNOA"></span>NOA</div>
        <!-- Fires -->
        <div class="badge"><span class="dot" id="srcFIRMS"></span>NASA FIRMS</div>
        <div class="badge"><span class="dot" id="srcEFFIS"></span>EFFIS</div>
        <!-- Floods -->
        <div class="badge"><span class="dot" id="srcGDACS"></span>GDACS</div>
        <div class="badge"><span class="dot" id="srcCEMS"></span>Copernicus EMS</div>
      </div>
      <div class="footer small">Green: OK · Yellow: Partial · Red: Error/Skipped</div>
    </div>

    <div class="panel">
      <h3>Filters</h3>
      <div class="controls">
        <div class="row">
          <div class="group">
            <label><input type="checkbox" id="chkEq" checked> Earthquakes</label>
          </div>
          <div class="group">
            <label><input type="checkbox" id="chkFire" checked> Fires</label>
          </div>
          <div class="group">
            <label><input type="checkbox" id="chkFlood" checked> Floods</label>
          </div>
        </div>
        <div class="row">
          <div>Time period</div>
          <select id="selPeriod">
            <option value="1">24 hours</option>
            <option value="3">3 days</option>
            <option value="7" selected>7 days</option>
            <option value="10">10 days (FIRMS max)</option>
          </select>
        </div>
        <div class="row">
          <div>Min magnitude</div>
          <select id="selMinMag">
            <option value="2" selected>2+</option>
            <option value="3">3+</option>
            <option value="4">4+</option>
            <option value="5">5+</option>
          </select>
        </div>
        <div class="row">
          <button class="btn" id="btnRefresh">Refresh</button>
          <div class="small" id="lastUpdated">—</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Data Sources</h3>
      <div class="small">
        Earthquakes: USGS, EMSC, NOA (if available)<br/>
        Fires: NASA FIRMS (VIIRS/MODIS)<br/>
        Floods: GDACS, Copernicus EMS (where accessible)
      </div>
    </div>
  </aside>

  <!-- MAP -->
  <main id="map"></main>
</div>

<div class="legend" id="legend">
  <div><span class="key eq"></span> Earthquake (size by M)</div>
  <div><span class="key fire"></span> Fire (FIRMS)</div>
  <div><span class="key flood"></span> Flood</div>
</div>

<script>
  // =========================
  // Configuration (edit here)
  // =========================

  // Your Cloudflare Worker base URL:
  const WORKER_BASE = "https://greece-disasters.odysseas-3d2.workers.dev"; // <— change if yours is different

  // Optional MapTiler (keeps your visual style). If empty, fallback to OSM tiles.
  const MAPTILER_KEY = "x1Q1SpeI9hPHQaeW1DEa";

  // Greece bounds
  const BOUNDS = [[34.8, 19.3], [41.8, 29.6]];

  // =========================
  // Map init
  // =========================
  const map = L.map('map', {
    minZoom: 5, maxZoom: 15, zoomControl: true
  });
  map.fitBounds(BOUNDS);

  let baseLayer;
  if (MAPTILER_KEY) {
    baseLayer = L.tileLayer(
      `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      { attribution: '&copy; MapTiler &copy; OpenStreetMap contributors', tileSize:256, crossOrigin:true }
    ).addTo(map);
  } else {
    baseLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '&copy; OpenStreetMap contributors' }
    ).addTo(map);
  }

  // Layers
  const eqLayer = L.layerGroup().addTo(map);
  const fireLayer = L.layerGroup().addTo(map);
  const floodLayer = L.layerGroup().addTo(map);

  // =========================
  // UI Elements
  // =========================
  const statEq = document.getElementById('statEq');
  const statFire = document.getElementById('statFire');
  const statFlood = document.getElementById('statFlood');
  const statTotal = document.getElementById('statTotal');
  const lastUpdated = document.getElementById('lastUpdated');

  const chkEq = document.getElementById('chkEq');
  const chkFire = document.getElementById('chkFire');
  const chkFlood = document.getElementById('chkFlood');
  const selPeriod = document.getElementById('selPeriod');
  const selMinMag = document.getElementById('selMinMag');
  const btnRefresh = document.getElementById('btnRefresh');

  // Source dots
  const sUSGS = document.getElementById('srcUSGS');
  const sEMSC = document.getElementById('srcEMSC');
  const sNOA = document.getElementById('srcNOA');
  const sFIRMS = document.getElementById('srcFIRMS');
  const sEFFIS = document.getElementById('srcEFFIS');
  const sGDACS = document.getElementById('srcGDACS');
  const sCEMS = document.getElementById('srcCEMS');

  // =========================
  // Helpers
  // =========================
  function setDot(el, val) {
    el.classList.remove('ok','err','warn');
    if (!val) return;
    const v = String(val).toLowerCase();
    if (v === 'ok' || v === 'success') el.classList.add('ok');
    else if (v === 'partial' || v === 'skipped') el.classList.add('warn');
    else el.classList.add('err');
  }

  function magColor(m){
    // yellow (low) → red (high)
    const c = Math.max(0, Math.min(1, (m - 2) / 4)); // 2..6+
    const r = Math.round(255 * c);
    const g = Math.round(255 * (1 - c));
    return `rgb(${r},${g},0)`;
  }

  function fmtTime(ts){
    const t = (typeof ts === 'string') ? Date.parse(ts) : Number(ts);
    if (!isFinite(t)) return '—';
    const d = new Date(t);
    return d.toLocaleString([], {hour12:false});
  }

  function withinBounds(lat, lon){
    return lat >= 34.8 && lat <= 41.8 && lon >= 19.3 && lon <= 29.6;
  }

  function clearLayers(){
    eqLayer.clearLayers();
    fireLayer.clearLayers();
    floodLayer.clearLayers();
  }

  // =========================
  // Renderers
  // =========================
  function renderEarthquakes(list){
    let count = 0;
    for (const f of list){
      const lat = Number(f.lat ?? f.latitude);
      const lon = Number(f.lon ?? f.longitude);
      if (!isFinite(lat) || !isFinite(lon)) continue;
      if (!withinBounds(lat, lon)) continue;

      const m = Number(f.mag ?? f.magnitude ?? 0);
      const depth = f.depth ?? '—';
      const when = fmtTime(f.time);
      const place = f.place || '—';
      const url = f.url || '';
      const srcs = Array.isArray(f.sources) ? f.sources.join(', ') : (f._src || '—');

      const radius = Math.max(4, m * 2.2);
      const circle = L.circleMarker([lat, lon], {
        radius,
        color: magColor(m),
        weight: 1.5,
        fillOpacity: 0.55
      });
      circle.bindPopup(
        `<strong>Earthquake</strong><br>
         Magnitude: <b>${m || '—'}</b><br>
         Depth: ${depth} km<br>
         Time: ${when}<br>
         Place: ${place}<br>
         Sources: ${srcs}<br>
         ${url ? `<a href="${url}" target="_blank" rel="noreferrer">Details</a>` : ''}`
      );
      circle.addTo(eqLayer);
      count++;
    }
    return count;
  }

  function renderFires(list){
    let count = 0;
    for (const f of list){
      const lat = Number(f.lat ?? f.latitude);
      const lon = Number(f.lon ?? f.longitude);
      if (!isFinite(lat) || !isFinite(lon)) continue;
      if (!withinBounds(lat, lon)) continue;

      // Handle both old/new field names
      const brightness = (f.brightness ?? f.bright ?? null);
      const confidence = (f.confidence ?? f.conf ?? '').toString();
      const when = fmtTime(f.time);

      const marker = L.circleMarker([lat, lon], {
        radius: 5,
        color: '#ff2d55',
        fillColor: '#ff2d55',
        weight: 1,
        fillOpacity: 0.7
      });
      marker.bindPopup(
        `<strong>Fire (FIRMS)</strong><br>
         Brightness: ${brightness ?? '—'}<br>
         Confidence: ${confidence || '—'}<br>
         Time: ${when}`
      );
      marker.addTo(fireLayer);
      count++;
    }
    return count;
  }

  function renderFloods(list){
    let count = 0;
    for (const f of list){
      const lat = Number(f.lat ?? f.latitude);
      const lon = Number(f.lon ?? f.longitude);
      if (!isFinite(lat) || !isFinite(lon)) continue;
      if (!withinBounds(lat, lon)) continue;

      const level = f.level ?? f.severity ?? '—';
      const area = f.area ?? f.name ?? '—';
      const when = fmtTime(f.time);

      const marker = L.circleMarker([lat, lon], {
        radius: 6,
        color: '#3399ff',
        fillColor: '#3399ff',
        weight: 1,
        fillOpacity: 0.6
      });
      marker.bindPopup(
        `<strong>Flood</strong><br>
         Area: ${area}<br>
         Level: ${level}<br>
         Time: ${when}`
      );
      marker.addTo(floodLayer);
      count++;
    }
    return count;
  }

  // =========================
  // Fetch + Wire-up
  // =========================
  async function loadAll(){
    const days = Number(selPeriod.value || 7);
    const minMag = Number(selMinMag.value || 2);

    // Clamp days for FIRMS (Worker already does this, but keep UI honest)
    const periodDays = Math.max(1, Math.min(10, days));

    const url = `${WORKER_BASE}/api?periodDays=${encodeURIComponent(periodDays)}&minMag=${encodeURIComponent(minMag)}`;
    try{
      btnRefresh.disabled = true;
      btnRefresh.textContent = 'Loading…';

      const res = await fetch(url, { headers: { 'accept':'application/json' }, cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const payload = await res.json();

      // Stats
      const eq = Array.isArray(payload.data?.earthquakes) ? payload.data.earthquakes : [];
      const fires = Array.isArray(payload.data?.fires) ? payload.data.fires : [];
      const floods = Array.isArray(payload.data?.floods) ? payload.data.floods : [];

      // Clear and render
      clearLayers();
      const eqCount = renderEarthquakes(eq);
      const fireCount = renderFires(fires);
      const floodCount = renderFloods(floods);

      statEq.textContent = eqCount;
      statFire.textContent = fireCount;
      statFlood.textContent = floodCount;
      statTotal.textContent = (eqCount + fireCount + floodCount);

      lastUpdated.textContent = payload.updated ? new Date(payload.updated).toLocaleString([], {hour12:false}) : 'now';

      // Source dots
      const src = payload.sources || {};
      const sEq = src.earthquakes || {};
      const sFi = src.fires || {};
      const sFl = src.floods || {};
      setDot(sUSGS, sEq.USGS);
      setDot(sEMSC, sEq.EMSC);
      setDot(sNOA, sEq.NOA);
      // Any FIRMS product OK → green; otherwise reflect first
      const firmsOverall = (sFi.FIRMS_MODIS === 'ok' || sFi.FIRMS_VIIRS === 'ok') ? 'ok' : (sFi.FIRMS_MODIS || sFi.FIRMS_VIIRS || 'skipped');
      setDot(sFIRMS, firmsOverall);
      setDot(sEFFIS, sFi.EFFIS || 'skipped');
      setDot(sGDACS, sFl.GDACS || 'skipped');
      setDot(sCEMS, sFl.CEMS || 'skipped');

      // Apply toggles
      if (!chkEq.checked) map.removeLayer(eqLayer); else eqLayer.addTo(map);
      if (!chkFire.checked) map.removeLayer(fireLayer); else fireLayer.addTo(map);
      if (!chkFlood.checked) map.removeLayer(floodLayer); else floodLayer.addTo(map);

    } catch(err){
      console.error('Load failed:', err);
      btnRefresh.textContent = 'Retry';
    } finally {
      btnRefresh.disabled = false;
      if (btnRefresh.textContent === 'Loading…') btnRefresh.textContent = 'Refresh';
    }
  }

  // Events
  btnRefresh.addEventListener('click', loadAll);
  selPeriod.addEventListener('change', loadAll);
  selMinMag.addEventListener('change', loadAll);
  chkEq.addEventListener('change', () => { if (chkEq.checked) eqLayer.addTo(map); else map.removeLayer(eqLayer); });
  chkFire.addEventListener('change', () => { if (chkFire.checked) fireLayer.addTo(map); else map.removeLayer(fireLayer); });
  chkFlood.addEventListener('change', () => { if (chkFlood.checked) floodLayer.addTo(map); else map.removeLayer(floodLayer); });

  // Initial + auto refresh
  loadAll();
  setInterval(loadAll, 10 * 60 * 1000); // 10 minutes
</script>
</body>
</html>
