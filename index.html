<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greece Official Disaster Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg:#101820;
      --panel:#121c26;
      --muted:#8aa0b2;
      --text:#e8f0f6;
      --green:#3dd87e;
      --red:#ff5c5c;
      --accent:#3aa0ff;
    }
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    #app { display:flex; height:100%; }
    #sidebar {
      width:280px; min-width:260px; max-width:340px;
      background:var(--panel); padding:12px 12px 56px; box-sizing:border-box; overflow:auto; border-right:1px solid #0b141c; position:relative;
    }
    #map { flex:1; }

    h1 { font-size:16px; margin:4px 0 6px; }
    .sub { font-size:12px; color:var(--muted); line-height:1.35; margin-bottom:10px; }
    .grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px; }
    .card {
      background:#0e1821; border:1px solid #0b141c; border-radius:8px; padding:8px;
    }
    .k { font-size:12px; color:var(--muted); }
    .v { font-size:20px; font-weight:700; margin-top:2px; }
    .row { display:flex; align-items:center; gap:8px; margin:8px 0; flex-wrap:wrap; }
    .muted { color:var(--muted); font-size:12px; }
    .controls label { font-size:13px; margin-right:8px; white-space:nowrap; }
    select, button {
      background:#0a141c; color:var(--text); border:1px solid #0b141c; border-radius:6px; padding:6px 8px; font-size:13px;
    }
    button { cursor:pointer; }
    .legend { font-size:12px; color:var(--muted); margin-top:10px; }
    .status-dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; vertical-align:middle; }
    .ok { background:var(--green); } .err { background:var(--red); }
    .updated { font-size:12px; color:var(--muted); }
    .divider { height:1px; background:#0b141c; margin:10px 0; }

    /* Data sources list */
    .sources { margin-top:6px; }
    .sources h3 { font-size:12px; color:#b9cedf; margin:6px 0; text-transform:uppercase; letter-spacing:.06em; }
    .sources ul { list-style:none; padding-left:0; margin:6px 0; }
    .sources li { display:flex; align-items:center; gap:6px; padding:4px 0; font-size:13px; color:#d8e6f3; }
    .sources small { color:var(--muted); margin-left:auto; }

    /* Footer */
    .footer {
      position:sticky; bottom:0; left:0; right:0;
      background:linear-gradient(180deg, rgba(16,24,32,0) 0%, #0e1821 40%);
      padding:10px 4px 8px; margin-top:12px;
      font-size:12px; color:var(--muted);
    }
    .footer a { color:#cde6ff; text-decoration:none; }
    .footer a:hover { text-decoration:underline; }

    /* Leaflet tweaks */
    .leaflet-control-zoom a { background:#0a141c; color:#fff; border:none; }
    .leaflet-control-zoom a:hover { background:#13202b; }

    /* Small status line */
    #render-status { font-size:12px; color:var(--muted); margin-top:6px; min-height:16px; }
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1>Greece Official Disaster Map</h1>
    <div class="sub">Live earthquakes and fires in Greece. Data refreshes automatically every 10 minutes.</div>

    <div class="grid">
      <div class="card">
        <div class="k">Earthquakes</div>
        <div class="v" id="stat-quakes">0</div>
      </div>
      <div class="card">
        <div class="k">Fires</div>
        <div class="v" id="stat-fires">0</div>
      </div>
      <div class="card" style="grid-column:1 / span 2;">
        <div class="k">Total</div>
        <div class="v" id="stat-total">0</div>
      </div>
    </div>

    <div class="row updated">Last updated: <span id="last-updated">—</span></div>
    <div id="render-status"></div>

    <div class="divider"></div>

    <div class="controls">
      <div class="row">
        <label><input type="checkbox" id="show-quakes" checked /> Earthquakes</label>
        <label><input type="checkbox" id="show-fires" checked /> Fires</label>
      </div>

      <div class="row">
        <select id="timeRange" title="Time period (affects both)">
          <option value="1">24 hours</option>
          <option value="3">3 days</option>
          <option value="7" selected>7 days</option>
          <option value="30">30 days</option>
          <option value="90">3 months</option>
          <option value="365">Last year</option>
        </select>

        <select id="minMag" title="Minimum earthquake magnitude">
          <option value="2">M 2+</option>
          <option value="3" selected>M 3+</option>
          <option value="4">M 4+</option>
          <option value="5">M 5+</option>
        </select>

        <button id="btn-refresh">Refresh</button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Data sources with status bullets -->
    <div class="sources">
      <h3>Data sources</h3>
      <ul id="source-list"></ul>
      <div class="legend">
        <div><span class="status-dot ok"></span>Source contributed data</div>
        <div><span class="status-dot err"></span>No data from source</div>
      </div>
    </div>

    <div class="footer">
      map built by <a href="https://www.holy.gd" target="_blank" rel="noopener">HØLY</a>
    </div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // ================== CONFIG ==================
  const API_BASE = 'https://greece-disasters.odysseas-3d2.workers.dev';
  const GRC_BBOX = { south:34.8, north:41.8, west:19.3, east:29.6 };

  // Performance knobs (do NOT change UI)
  const FIRE_BATCH = 600;          // draw in chunks
  const FIRE_HARD_CAP = 6000;      // max to render (avoid UI lock with 6k+ points)
  const DEFAULT_FIRE_CONF = 60;    // default server-side filter to keep map usable
  const DEFAULT_FIRE_FRP  = 5;

  // ============================================

  // Map
  const map = L.map('map', { zoomSnap: 0.25, preferCanvas: true });
  const center = [(GRC_BBOX.south + GRC_BBOX.north)/2, (GRC_BBOX.west + GRC_BBOX.east)/2];
  map.setView(center, 6.25);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // Use a shared Canvas renderer for speed
  const canvasRenderer = L.canvas({ padding: 0.2 });

  const quakesLayer = L.layerGroup().addTo(map);
  const firesLayer  = L.layerGroup().addTo(map);

  // UI
  const $ = sel => document.querySelector(sel);
  const statQuakes = $('#stat-quakes');
  const statFires  = $('#stat-fires');
  const statTotal  = $('#stat-total');
  const lastUpdated = $('#last-updated');
  const sourceList = $('#source-list');
  const renderStatus = $('#render-status');

  // Inputs
  const showQuakes = $('#show-quakes');
  const showFires  = $('#show-fires');
  const timeRange  = $('#timeRange');
  const minMagSel  = $('#minMag');
  const btnRefresh = $('#btn-refresh');

  showQuakes.addEventListener('change', () => { quakesLayer.clearLayers(); drawQuakes(_quakesFiltered); if (!showQuakes.checked) quakesLayer.clearLayers(); });
  showFires.addEventListener('change',  () => { firesLayer.clearLayers();  drawFiresIncremental(_firesFiltered); if (!showFires.checked) firesLayer.clearLayers(); });

  timeRange.addEventListener('change', () => refresh(true));
  minMagSel.addEventListener('change', () => refresh(true));
  btnRefresh.addEventListener('click', () => refresh(true));

  // Data caches (in-memory)
  let _quakesRaw = [], _firesRaw = [];
  let _quakesFiltered = [], _firesFiltered = [];

  function toMs(t) {
    if (typeof t === 'number') return t;
    const parsed = Date.parse(t);
    return Number.isFinite(parsed) ? parsed : 0;
  }
  function cutoffMs(days) { return Date.now() - Number(days) * 24 * 60 * 60 * 1000; }
  function withinGreece(lat, lon) {
    return lat >= GRC_BBOX.south && lat <= GRC_BBOX.north && lon >= GRC_BBOX.west && lon <= GRC_BBOX.east;
  }
  async function fetchJSON(url, timeoutMs = 20000) {
    const ac = new AbortController();
    const id = setTimeout(() => ac.abort('timeout'), timeoutMs);
    try {
      const res = await fetch(url, { cache: 'no-store', signal: ac.signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    } finally { clearTimeout(id); }
  }
  function fmtTime(ms) { const d = new Date(ms); return d.toLocaleString([], { hour12:false }); }
  function quakeColor(m) {
    const clamped = Math.max(2, Math.min(6.5, m || 0));
    const t = (clamped - 2) / 4.5;
    const r = Math.round(255 * t);
    const g = Math.round(200 * (1 - t) + 40 * t);
    return `rgb(${r},${g},0)`;
  }
  function quakeRadius(m) { return 6 + Math.pow(Math.max(0, m), 1.6); }
  function fireColor(verified) { return verified ? '#ff3b3b' : '#ffb347'; }
  function fireRadius(brightness) {
    const b = Number(brightness) || 0;
    return 4 + Math.min(10, (b - 300) / 8);
  }
  function updateStats() {
    const q = _quakesFiltered.length;
    const f = _firesFiltered.length;
    statQuakes.textContent = q.toLocaleString();
    statFires.textContent  = f.toLocaleString();
    statTotal.textContent  = (q + f).toLocaleString();
    lastUpdated.textContent = new Date().toLocaleTimeString([], { hour12:false });
  }

  // --------- Custom quake marker with magnitude label ----------
  function makeQuakeIcon(mag) {
    const m = Number(mag) || 0;
    const size = Math.round(quakeRadius(m) * 2);
    const color = quakeColor(m);
    const font = 10; // px
    const style = `
      width:${size}px;height:${size}px;
      border-radius:50%;
      background:${color};
      color:#fff;
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:${font}px;line-height:1;
      border:1px solid rgba(0,0,0,.35);
      box-shadow:0 0 0 1px rgba(0,0,0,.15), 0 1px 4px rgba(0,0,0,.35);
    `;
    const html = `<div style="${style}">${m.toFixed(1)}</div>`;
    return L.divIcon({ html, className:'', iconSize:[size,size], iconAnchor:[size/2,size/2] });
  }

  function drawQuakes(quakes) {
    if (!showQuakes.checked) return;
    for (const e of quakes) {
      const { lat, lon } = e;
      if (!withinGreece(lat, lon)) continue;
      const mag = Number(e.mag) || 0;
      const marker = L.marker([lat, lon], { icon: makeQuakeIcon(mag) });
      const timeMs = toMs(e.time);
      const place = e.place || '—';
      const depth = (e.depth ?? '—');
      const srcs  = Array.isArray(e.sources) ? e.sources.join(', ') : (e._src || '—');
      const link  = e.url ? `<br/><a href="${e.url}" target="_blank" rel="noopener">details</a>` : '';
      marker.bindPopup(
        `<b>Magnitude:</b> M ${mag.toFixed(1)}<br/>
         <b>Depth:</b> ${depth} km<br/>
         <b>Time:</b> ${fmtTime(timeMs)}<br/>
         <b>Place:</b> ${place}<br/>
         <b>Sources:</b> ${srcs}${link}`
      );
      marker.addTo(quakesLayer);
    }
  }

  // ---- Incremental, Canvas-accelerated fire rendering ----
  function drawFiresIncremental(fires) {
    if (!showFires.checked) return;
    renderStatus.textContent = '';
    const n = fires.length;
    if (n === 0) return;

    let list = fires.filter(f => withinGreece(f.lat, f.lon));

    // Hard cap to avoid UI lock if API returns 6k+ points
    let capped = false;
    if (list.length > FIRE_HARD_CAP) {
      list = list.slice(0, FIRE_HARD_CAP);
      capped = true;
    }

    const total = list.length;
    let i = 0;

    function step() {
      const end = Math.min(i + FIRE_BATCH, total);
      for (; i < end; i++) {
        const f = list[i];
        const color = fireColor(!!f.verified);
        const radius = Math.max(3, fireRadius(f.brightness));
        L.circleMarker([f.lat, f.lon], {
          renderer: canvasRenderer,
          radius, color, weight:1, fillColor: color, fillOpacity:0.6
        }).bindPopup(
          `<b>Brightness:</b> ${f.brightness ?? '—'}<br/>
           <b>FRP:</b> ${f.frp ?? '—'}<br/>
           <b>Confidence:</b> ${f.confidence ?? '—'}<br/>
           <b>Time:</b> ${fmtTime(toMs(f.time))}<br/>
           <b>Sources:</b> ${(Array.isArray(f.sources) ? f.sources.join(', ') : (f._src || '—'))}
          `
        ).addTo(firesLayer);
      }
      renderStatus.textContent = `Rendering fires: ${end.toLocaleString()} / ${total.toLocaleString()}${capped ? ' (capped)' : ''}`;
      if (i < total) {
        // Yield back to UI; prefer idle if available
        if ('requestIdleCallback' in window) {
          requestIdleCallback(step, { timeout: 200 });
        } else {
          setTimeout(step, 0);
        }
      } else {
        // done
        setTimeout(() => { renderStatus.textContent = ''; }, 800);
      }
    }
    step();
  }

  // Build "did this source contribute data?" map for UI bullets
  function updateSourcesUI() {
    const sourceKeys = [
      {key:'USGS', label:'USGS (Earthquakes)'},
      {key:'EMSC', label:'EMSC (Earthquakes)'},
      {key:'NOA',  label:'NOA (Earthquakes)'},
      {key:'FIRMS', label:'NASA FIRMS (Fires)'},
      {key:'EFFIS', label:'EFFIS (Fires)'}
    ];
    const contributed = {};
    for (const e of _quakesFiltered) {
      const ss = Array.isArray(e.sources) ? e.sources : [e._src].filter(Boolean);
      if (ss.includes('USGS')) contributed['USGS'] = true;
      if (ss.includes('EMSC')) contributed['EMSC'] = true;
      if (ss.includes('NOA'))  contributed['NOA']  = true;
    }
    for (const f of _firesFiltered) {
      const ss = Array.isArray(f.sources) ? f.sources : [f._src].filter(Boolean);
      if (ss.some(s => /VIIRS|MODIS/i.test(s))) contributed['FIRMS'] = true;
      if (ss.includes('EFFIS')) contributed['EFFIS'] = true;
    }
    sourceList.innerHTML = '';
    for (const {key,label} of sourceKeys) {
      const ok = !!contributed[key];
      const li = document.createElement('li');
      const dot = document.createElement('span');
      dot.className = 'status-dot ' + (ok ? 'ok' : 'err');
      const txt = document.createElement('span');
      txt.textContent = label;
      const tail = document.createElement('small');
      tail.textContent = ok ? 'data present' : 'no data';
      li.appendChild(dot); li.appendChild(txt); li.appendChild(tail);
      sourceList.appendChild(li);
    }
  }

  function applyFilters() {
    const days = Number(timeRange.value);
    const minMag = Number(minMagSel.value);
    const cutoff = cutoffMs(days);

    _quakesFiltered = _quakesRaw.filter(e => {
      const t = toMs(e.time);
      const m = Number(e.mag) || 0;
      return t >= cutoff && m >= minMag && withinGreece(e.lat, e.lon);
    });

    _firesFiltered = _firesRaw.filter(f => toMs(f.time) >= cutoff && withinGreece(f.lat, f.lon));

    quakesLayer.clearLayers();
    firesLayer.clearLayers();
    drawQuakes(_quakesFiltered);
    drawFiresIncremental(_firesFiltered);
    updateStats();
    updateSourcesUI();
  }

  async function refresh(force = false) {
    const days = Number(timeRange.value);
    const minMag = Number(minMagSel.value);
    const buster = force ? `&t=${Date.now()}` : '';

    // Default-fire filters to avoid 6k+ points freezing UI.
    const firesUrl  = `${API_BASE}/fires?days=${days}&minconfidence=${DEFAULT_FIRE_CONF}&minfrp=${DEFAULT_FIRE_FRP}${buster}`;
    const quakesUrl = `${API_BASE}/earthquakes?days=${days}&minmag=${minMag}${buster}`;

    try {
      renderStatus.textContent = 'Loading…';
      const [q, f] = await Promise.allSettled([ fetchJSON(quakesUrl, 25000), fetchJSON(firesUrl, 30000) ]);

      if (q.status === 'fulfilled') _quakesRaw = Array.isArray(q.value?.data) ? q.value.data : [];
      if (f.status === 'fulfilled') _firesRaw  = Array.isArray(f.value?.data) ? f.value.data : [];

      applyFilters();
    } catch (err) {
      console.error('Fetch error:', err);
      lastUpdated.textContent = new Date().toLocaleTimeString([], { hour12:false });
      renderStatus.textContent = 'Load error';
      setTimeout(() => { renderStatus.textContent = ''; }, 2500);
    }
  }

  // Initial load + auto-refresh
  refresh(true);
  setInterval(() => refresh(false), 10 * 60 * 1000);

  map.fitBounds([[GRC_BBOX.south, GRC_BBOX.west],[GRC_BBOX.north, GRC_BBOX.east]]);
</script>
</body>
</html>
