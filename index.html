<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Greece Official Disaster Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha512-sA+e2JbE1kG4YQ8G9bqocR6G7Fq2d+mq6XfP4Yk1/dqW7sZzjz1w2dC0RrNnYk3KQ2n9Jr7WvVnYw7D7fKQ+kw==" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha512-vRv7kVLdM8K9G7K8y5a0C8dKQK2mTx0Qx7q7o3A1oE0Jq8y3Q0z7YlWb8M1FhQ0gQ8m8b2G3C0n9f3mC2g8Rfw==" crossorigin=""></script>
<!-- PapaParse (kept for spec; not needed with Worker parsing, but harmless) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root {
    --sidebar-w: 360px;
    --bg: #0b1220;
    --panel: #121a2a;
    --muted: #93a2b8;
    --text: #eaf1ff;
    --accent: #4cc9f0;
    --good: #31c48d;
    --bad: #ef4444;
    --warn: #fbbf24;
    --blue: #3b82f6;
    --red: #ef4444;
    --yellow: #f59e0b;
  }
  html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
  #app { display: grid; grid-template-columns: var(--sidebar-w) 1fr; height: 100%; }
  aside {
    padding: 16px;
    background: var(--panel);
    border-right: 1px solid rgba(255,255,255,0.05);
    overflow: auto;
  }
  h1 { margin: 0 0 8px; font-size: 20px; }
  small.desc { color: var(--muted); display: block; margin-bottom: 12px; line-height: 1.3; }
  .section { margin-top: 14px; }
  .section h2 { font-size: 13px; margin: 0 0 8px; color: var(--muted); letter-spacing: .02em; text-transform: uppercase; }
  .row { display: flex; gap: 8px; align-items: center; }
  input[type="text"], select {
    width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);
    background: #0e1524; color: var(--text);
  }
  .btn { background: var(--accent); color: #00121f; font-weight: 600; border: 0; padding: 8px 12px; border-radius: 10px; cursor: pointer; }
  .btn.secondary { background: #1f2a44; color: var(--text); }
  .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .card { background: #0e1524; border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; }
  .kpi { font-size: 22px; font-weight: 700; }
  .label { font-size: 12px; color: var(--muted); }
  .sources { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .source { display: flex; justify-content: space-between; align-items: center; background: #0e1524; border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 8px 10px; font-size: 13px; }
  .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--warn); box-shadow: 0 0 0 2px rgba(255,255,255,0.05) inset; }
  .dot.ok { background: var(--good); }
  .dot.error { background: var(--bad); }
  .filters .row { justify-content: space-between; }
  .filters .row > label { display: flex; align-items: center; gap: 6px; font-size: 14px; }
  #map { width: 100%; height: 100%; }
  .footer { margin-top: 12px; font-size: 12px; color: var(--muted); }
  .list { font-size: 12px; color: var(--muted); margin-top: 6px; }
  .last-upd { font-size: 12px; color: var(--muted); margin-top: 6px; }
  a.link { color: var(--accent); text-decoration: none; }
</style>
</head>
<body>
<div id="app">
  <aside>
    <h1>Greece Official Disaster Map</h1>
    <small class="desc">Live earthquakes and fires in Greece. Data refreshes automatically every 10 minutes.</small>

    <div class="section">
      <h2>API endpoint</h2>
      <div class="row">
        <input id="apiBase" type="text" placeholder="https://your-worker.example.workers.dev" />
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn secondary" id="saveApiBtn">Save</button>
        <button class="btn secondary" id="testApiBtn">Test</button>
      </div>
      <div class="last-upd" id="apiStatus"></div>
    </div>

    <div class="section">
      <h2>Live stats</h2>
      <div class="stats">
        <div class="card"><div class="kpi" id="statEq">0</div><div class="label">Earthquakes</div></div>
        <div class="card"><div class="kpi" id="statFire">0</div><div class="label">Fires</div></div>
        <div class="card"><div class="kpi" id="statFlood">0</div><div class="label">Floods</div></div>
        <div class="card"><div class="kpi" id="statTotal">0</div><div class="label">Total</div></div>
      </div>
    </div>

    <div class="section">
      <h2>Source status</h2>
      <div class="sources" id="sourceStatus">
        <!-- filled by JS -->
      </div>
    </div>

    <div class="section filters">
      <h2>Filters</h2>
      <div class="row" style="gap:12px;">
        <label><input type="checkbox" id="toggleEq" checked /> Earthquakes</label>
        <label><input type="checkbox" id="toggleFire" checked /> Fires</label>
      </div>
      <div class="row" style="margin-top:8px;">
        <select id="period">
          <option value="1d">24 hours</option>
          <option value="3d">3 days</option>
          <option value="7d" selected>7 days</option>
          <option value="30d">30 days</option>
          <option value="90d">3 months</option>
          <option value="365d">Last year</option>
        </select>
        <select id="minMag">
          <option value="2">M 2+</option>
          <option value="3" selected>M 3+</option>
          <option value="4">M 4+</option>
          <option value="5">M 5+</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="btn" id="refreshBtn">Refresh</button>
      </div>
      <div class="last-upd" id="lastUpdated">Last updated: —</div>
    </div>

    <div class="section">
      <h2>Data sources</h2>
      <div class="list">
        Earthquakes: USGS, EMSC (Seismic Portal)<br />
        Fires: NASA FIRMS (VIIRS SNPP/NOAA-20, MODIS)
      </div>
    </div>

    <div class="footer">© Live, client-side map. Built with Leaflet.</div>
  </aside>

  <div id="map"></div>
</div>

<script>
/** ====== Config & state ====== */
const GREECE_BOUNDS = [[34.8, 19.3],[41.8, 29.6]]; // [southWest, northEast]
const STORAGE_KEY = "greece.disaster.apiBase";

// API base resolution: ?api=... → localStorage → (empty = must set once)
const urlParams = new URLSearchParams(location.search);
const apiFromQuery = urlParams.get("api");
if (apiFromQuery) localStorage.setItem(STORAGE_KEY, apiFromQuery);
const API_BASE = localStorage.getItem(STORAGE_KEY) || "";

const $ = s => document.querySelector(s);
$("#apiBase").value = API_BASE;
$("#saveApiBtn").addEventListener("click", () => {
  const v = $("#apiBase").value.trim();
  if (!v) { notifyApi("Please paste your Worker URL."); return; }
  localStorage.setItem(STORAGE_KEY, v);
  notifyApi("Saved.");
});
$("#testApiBtn").addEventListener("click", async () => {
  try {
    const base = ($("#apiBase").value || "").trim();
    if (!base) return notifyApi("Enter your Worker URL first.");
    const r = await fetch(base + "/api/earthquakes?period=1d&minmag=3", { cache: "no-store" });
    notifyApi(r.ok ? "API reachable ✔" : `API error: ${r.status}`);
  } catch (e) {
    notifyApi("API not reachable.");
  }
});
function notifyApi(msg) { $("#apiStatus").textContent = msg; }

let map, eqLayer, fireLayer;
initMap();

const els = {
  statEq: $("#statEq"),
  statFire: $("#statFire"),
  statFlood: $("#statFlood"),
  statTotal: $("#statTotal"),
  lastUpdated: $("#lastUpdated"),
  srcStatus: $("#sourceStatus"),
  toggleEq: $("#toggleEq"),
  toggleFire: $("#toggleFire"),
  period: $("#period"),
  minMag: $("#minMag"),
  refresh: $("#refreshBtn")
};

els.toggleEq.addEventListener("change", () => { eqLayer.eachLayer(l => l.setStyle ? l.setStyle({opacity: els.toggleEq.checked ? 1 : 0, fillOpacity: els.toggleEq.checked ? 0.5 : 0}) : null); });
els.toggleFire.addEventListener("change", () => { fireLayer.eachLayer(l => l.setStyle ? l.setStyle({opacity: els.toggleFire.checked ? 1 : 0, fillOpacity: els.toggleFire.checked ? 0.7 : 0}) : null); });
els.period.addEventListener("change", refreshAll);
els.minMag.addEventListener("change", refreshAll);
els.refresh.addEventListener("click", refreshAll);

/** ====== Fetch & render ====== */
let autoTimer = null;
refreshAll(); // initial
scheduleAuto();

function scheduleAuto() {
  if (autoTimer) clearInterval(autoTimer);
  autoTimer = setInterval(refreshAll, 10 * 60 * 1000); // 10 min
}

async function refreshAll() {
  const base = ($("#apiBase").value || "").trim();
  if (!base) {
    notifyApi("Set your Worker URL to load data.");
    return;
  }
  localStorage.setItem(STORAGE_KEY, base);

  const period = els.period.value;
  const minmag = els.minMag.value;

  // Clear old layers
  eqLayer.clearLayers();
  fireLayer.clearLayers();

  // Parallel fetches
  const [eqRes, fireRes] = await Promise.allSettled([
    fetch(`${base}/api/earthquakes?period=${encodeURIComponent(period)}&minmag=${encodeURIComponent(minmag)}`, { cache: "no-store" }),
    fetch(`${base}/api/fires?period=${encodeURIComponent(period)}`, { cache: "no-store" })
  ]);

  let eqData = [], fireData = [];
  let sources = { earthquakes:{}, fires:{} };
  let updatedStr = new Date().toLocaleString();

  // Earthquakes handling
  if (eqRes.status === "fulfilled" && eqRes.value.ok) {
    try {
      const j = await eqRes.value.json();
      const arr = (j?.data?.earthquakes) || [];
      // NO LIMIT: plot all
      eqData = arr.filter(v => isFinite(v.lat) && isFinite(v.lon));
      sources.earthquakes = (j?.sources?.earthquakes) || {};
      updatedStr = j?.updated || updatedStr;
    } catch {
      // ignore parse errors, already handled by Worker usually
    }
  }

  // Fires handling
  if (fireRes.status === "fulfilled" && fireRes.value.ok) {
    try {
      const j = await fireRes.value.json();
      const arr = j?.data || [];
      fireData = arr.filter(v => isFinite(v.lat) && isFinite(v.lon));
      sources.fires = (j?.sources?.fires) || {};
      updatedStr = j?.updated || updatedStr;
    } catch {}
  }

  // Draw earthquakes
  for (const q of eqData) {
    const m = q.mag ?? 0;
    const color = magColor(m);
    const radius = magRadius(m);
    const popup = `
      <div style="min-width:220px">
        <div><strong>M ${fmt(m)}</strong> • ${escapeHtml(q.place || "")}</div>
        <div>${q.time ? new Date(q.time).toLocaleString() : ""}</div>
        <div>Depth: ${q.depth != null ? `${fmt(q.depth)} km` : "—"}</div>
        <div>Sources: ${(q.sources||[]).join(", ")}</div>
        ${q.url ? `<div><a class="link" href="${q.url}" target="_blank" rel="noopener">Detail</a></div>` : ""}
      </div>
    `;
    L.circleMarker([q.lat, q.lon], {
      radius, color, weight: 1.5, fillColor: color, fillOpacity: 0.5
    }).bindPopup(popup).addTo(eqLayer);
  }

  // Draw fires
  for (const f of fireData) {
    const color = f.verified ? "#36d399" : "#ef4444";
    const popup = `
      <div style="min-width:220px">
        <div><strong>Fire pixel</strong> • ${f.verified ? "Verified (2+ sources)" : "Single source"}</div>
        <div>${f.time ? new Date(f.time).toLocaleString() : ""}</div>
        <div>Brightness: ${fmt(f.brightness)} | FRP: ${fmt(f.frp)}</div>
        <div>Confidence: ${escapeHtml(String(f.confidence ?? "—"))}</div>
        <div>Sources: ${(f.sources||[]).join(", ")}</div>
      </div>
    `;
    L.circleMarker([f.lat, f.lon], {
      radius: 4.5, color, weight: 1, fillColor: color, fillOpacity: 0.7
    }).bindPopup(popup).addTo(fireLayer);
  }

  // Update stats
  const eqCount = eqData.length;
  const fireCount = fireData.length;
  els.statEq.textContent = eqCount;
  els.statFire.textContent = fireCount;
  els.statFlood.textContent = 0;
  els.statTotal.textContent = eqCount + fireCount;

  // Update sources panel
  renderSources(sources);

  // Updated time
  els.lastUpdated.textContent = "Last updated: " + new Date(updatedStr).toLocaleString();

  // Toggle visibility per checkbox (post-draw)
  els.toggleEq.dispatchEvent(new Event("change"));
  els.toggleFire.dispatchEvent(new Event("change"));
}

/** ====== UI helpers ====== */
function renderSources(sources) {
  const items = [];
  // Earthquakes
  items.push(srcRow("USGS", (sources.earthquakes||{}).USGS));
  items.push(srcRow("EMSC", (sources.earthquakes||{}).EMSC));
  items.push(srcRow("NOA", (sources.earthquakes||{}).NOA));
  // Fires
  items.push(srcRow("FIRMS", (sources.fires||{}).FIRMS));
  items.push(srcRow("EFFIS", (sources.fires||{}).EFFIS));
  // (Flood providers listed for completeness)
  items.push(srcRow("GDACS", (sources.floods||{}).GDACS));
  items.push(srcRow("Copernicus EMS", (sources.floods||{}).CEMS));

  $("#sourceStatus").innerHTML = items.join("");
}
function srcRow(name, state) {
  const s = String(state || "skipped").toLowerCase();
  const cls = s === "ok" ? "ok" : (s === "error" ? "error" : "");
  const cap = s.charAt(0).toUpperCase() + s.slice(1);
  return `<div class="source"><span>${name}</span><span class="row" style="gap:8px;"><span>${cap}</span><span class="dot ${cls}"></span></span></div>`;
}

/** ====== Map & styling ====== */
function initMap() {
  map = L.map("map", {
    zoomControl: true,
    attributionControl: true
  }).fitBounds(GREECE_BOUNDS);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: '&copy; <a class="link" href="https://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a>'
  }).addTo(map);

  eqLayer = L.layerGroup().addTo(map);
  fireLayer = L.layerGroup().addTo(map);
}

function magColor(m) {
  if (m >= 6) return "#b91c1c"; // deep red
  if (m >= 5) return "#ef4444"; // red
  if (m >= 4) return "#f59e0b"; // amber
  if (m >= 3) return "#fde047"; // yellow
  return "#eab308"; // light yellow
}
function magRadius(m) {
  // Smooth radius: base 4 + 2.2^m / scaling
  const r = 4 + Math.pow(2.2, Math.max(0, m)) / 20;
  return Math.max(4, Math.min(18, r));
}
function fmt(v) {
  if (v == null || Number.isNaN(Number(v))) return "—";
  const n = Number(v);
  return (Math.abs(n) >= 100 ? n.toFixed(0) : (Math.abs(n) >= 10 ? n.toFixed(1) : n.toFixed(2)));
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}
</script>

<!-- Inline doc notes (per your original spec):
- FIRMS region: handled server-side in your Worker. This UI just reads the Worker JSON.
- USGS bbox/min magnitude/time: controlled by the filter UI -> query params to Worker.
- EMSC/NOA/EFFIS/GDACS/Copernicus: statuses shown from Worker response; endpoints configured in the Worker.
- CORS: your Worker sets permissive headers; this UI calls it directly. -->

</body>
</html>
