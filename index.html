<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Greece Official Disaster Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Optional: PapaParse (not strictly needed when using the Worker, but kept for future) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;          /* slate-900 */
      --panel: #111827;       /* gray-900 */
      --muted: #6b7280;       /* gray-500 */
      --text: #e5e7eb;        /* gray-200 */
      --accent: #22c55e;      /* green-500 */
      --accent-err: #ef4444;  /* red-500 */
      --accent-warn: #f59e0b; /* amber-500 */
      --card: #0b1220;        /* deep slate */
      --chip: #1f2937;        /* gray-800 */
      --border: #1f2937;      /* gray-800 */
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1020 0%, #0a0f1e 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    #app {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 0;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      background: rgba(11, 18, 32, 0.9);
      backdrop-filter: blur(8px);
      border-right: 1px solid var(--border);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .brand {
      display: grid;
      grid-template-columns: 40px 1fr;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 14px;
      background:
        radial-gradient(120px 120px at -20% -20%, rgba(59,130,246,0.18) 0%, rgba(59,130,246,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.0));
      border: 1px solid var(--border);
    }
    .logo {
      height: 40px; width: 40px; border-radius: 12px;
      display: grid; place-items: center;
      background:
        radial-gradient(120px 120px at 120% 120%, rgba(16,185,129,0.2) 0%, rgba(16,185,129,0) 60%),
        #0b1220;
      border: 1px solid var(--border);
      color: #93c5fd;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .sub {
      margin: 2px 0 0 0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .panel {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.00));
      border-radius: 14px;
      padding: 12px;
    }
    .panel h2 {
      margin: 0 0 10px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .stat {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
    }
    .stat .label {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .stat .value {
      margin-top: 6px;
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .updated {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    /* Source statuses */
    .sources {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
    }
    .source-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
    }
    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--muted);
    }
    .pill.ok { color: #22c55e; border-color: rgba(34,197,94,0.3); }
    .pill.err { color: #ef4444; border-color: rgba(239,68,68,0.3); }
    .pill.loading { color: #f59e0b; border-color: rgba(245,158,11,0.3); }

    /* Filters */
    .filters {
      display: grid;
      gap: 10px;
    }
    .row {
      display: flex; gap: 10px; align-items: center;
    }
    .row label { font-size: 13px; color: #cbd5e1; }
    .row input[type="checkbox"] { transform: translateY(1px); }
    select, button {
      width: 100%;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
    }
    button {
      cursor: pointer;
      background: linear-gradient(180deg, rgba(34,197,94,0.16), rgba(34,197,94,0.06));
      border-color: rgba(34,197,94,0.35);
      font-weight: 600;
    }
    button:hover { filter: brightness(1.08); }

    .tiny {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Map */
    #map { width: 100%; height: 100%; }

    /* Small screens */
    @media (max-width: 900px) {
      #app { grid-template-columns: 1fr; }
      .sidebar { height: 56vh; overflow: auto; }
      #map { height: 44vh; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">GR</div>
        <div>
          <h1>Greece Official Disaster Map</h1>
          <div class="sub">Live earthquakes, fires, and floods for Greece (aggregated via Cloudflare Worker).</div>
        </div>
      </div>

      <section class="panel">
        <h2>Live stats</h2>
        <div class="stats">
          <div class="stat">
            <div class="label">Earthquakes</div>
            <div class="value" id="eqCount">0</div>
          </div>
          <div class="stat">
            <div class="label">Fires</div>
            <div class="value" id="fireCount">0</div>
          </div>
          <div class="stat">
            <div class="label">Floods</div>
            <div class="value" id="floodCount">0</div>
          </div>
          <div class="stat">
            <div class="label">Total</div>
            <div class="value" id="totalCount">0</div>
          </div>
        </div>
        <div class="updated">Updated: <span id="lastUpdated">—</span></div>
      </section>

      <section class="panel">
        <h2>Source status</h2>
        <div class="sources">
          <div class="source-row">
            <span>USGS</span><span class="pill loading" id="status-USGS">…</span>
          </div>
          <div class="source-row">
            <span>EMSC</span><span class="pill loading" id="status-EMSC">…</span>
          </div>
          <div class="source-row">
            <span>NOA</span><span class="pill loading" id="status-NOA">…</span>
          </div>
          <div class="source-row">
            <span>NASA FIRMS (MODIS)</span><span class="pill loading" id="status-FIRMS_MODIS">…</span>
          </div>
          <div class="source-row">
            <span>NASA FIRMS (VIIRS)</span><span class="pill loading" id="status-FIRMS_VIIRS">…</span>
          </div>
          <div class="source-row">
            <span>EFFIS</span><span class="pill loading" id="status-EFFIS">…</span>
          </div>
          <div class="source-row">
            <span>GDACS</span><span class="pill loading" id="status-GDACS">…</span>
          </div>
          <div class="source-row">
            <span>Copernicus EMS</span><span class="pill loading" id="status-CEMS">…</span>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Filters</h2>
        <div class="filters">
          <div class="row">
            <label><input type="checkbox" id="filter-quakes" checked /> Earthquakes</label>
            <label><input type="checkbox" id="filter-fires" checked /> Fires</label>
            <label><input type="checkbox" id="filter-floods" checked /> Floods</label>
          </div>
          <div class="row">
            <select id="time-period" title="Time period">
              <option value="24h" selected>Last 24 hours</option>
              <option value="3d">Last 3 days</option>
              <option value="7d">Last 7 days</option>
              <option value="30d">Last 30 days</option>
              <option value="3m">Last 3 months</option>
              <option value="1y">Last year</option>
            </select>
          </div>
          <div class="row">
            <select id="min-mag" title="Minimum magnitude">
              <option value="2" selected>Earthquakes: M 2+</option>
              <option value="3">M 3+</option>
              <option value="4">M 4+</option>
              <option value="5">M 5+</option>
            </select>
          </div>
          <button id="refresh-btn">Refresh</button>
          <div class="tiny">
            Data are aggregated by your Cloudflare Worker and refreshed automatically every 10 minutes.
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Sources</h2>
        <div class="tiny">
          Earthquakes: USGS, EMSC, NOA<br/>
          Fires: NASA FIRMS, EFFIS<br/>
          Floods: GDACS, Copernicus EMS
        </div>
      </section>
    </aside>

    <!-- Map -->
    <main id="map"></main>
  </div>

  <script>
    // === REQUIRED KEYS / ENDPOINT ===
    // Your MapTiler key (you gave me this one)
    window.MAPTILER_KEY = 'x1Q1SpeI9hPHQaeW1DEa';
    // Your Cloudflare Worker aggregate endpoint:
    const WORKER_ENDPOINT = 'https://greece-disasters.odysseas-3d2.workers.dev/aggregate';
  </script>

  <script>
  // ====== MAP INIT ======
  (function initMap() {
    if (window.map) return;
    const centerGR = [38.3, 23.7]; // roughly central Greece
    const map = L.map('map', { zoomControl: true }).setView(centerGR, 6);
    L.tileLayer(
      `https://api.maptiler.com/maps/positron/{z}/{x}/{y}.png?key=${window.MAPTILER_KEY}`,
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://www.maptiler.com/">MapTiler</a>'
      }
    ).addTo(map);

    window.earthquakesLayer = L.layerGroup().addTo(map);
    window.firesLayer = L.layerGroup().addTo(map);
    window.floodsLayer = L.layerGroup().addTo(map);

    window.map = map;
  })();
  </script>

  <!-- DATA ADAPTER: fetch from Worker and draw -->
  <script>
  (() => {
    const GREECE_BBOX = [19.3, 34.8, 29.6, 41.8]; // [west,south,east,north] required by Worker
    const AUTO_REFRESH_MS = 10 * 60 * 1000;

    const el = (sel) => document.querySelector(sel);

    // Filters (read from UI if present)
    const getDays = () => {
      const dd = el('#time-period');
      if (!dd) return 1;
      const v = dd.value || '24h';
      const map = { '24h':1, '3d':3, '7d':7, '30d':10, '3m':10, '1y':10 }; // Worker caps FIRMS to <=10
      return map[v] ?? 1;
    };
    const getMinMag = () => {
      const dd = el('#min-mag');
      if (!dd) return 2;
      const m = parseFloat(dd.value);
      return isFinite(m) ? m : 2;
    };

    // Element refs (optional in UI)
    const chkQuakes = el('#filter-quakes');
    const chkFires  = el('#filter-fires');
    const chkFloods = el('#filter-floods');

    const statEq    = el('#eqCount');
    const statFi    = el('#fireCount');
    const statFl    = el('#floodCount');
    const statTotal = el('#totalCount');
    const updatedAt = el('#lastUpdated');

    const statusEl = (name) => el(`#status-${name}`);

    function quakeColor(m) {
      if (m >= 6) return '#d73027';
      if (m >= 5) return '#f46d43';
      if (m >= 4) return '#fdae61';
      if (m >= 3) return '#fee08b';
      return '#ffffbf';
    }
    function toLocal(ts) { try { return new Date(ts).toLocaleString(); } catch { return ''; } }

    async function loadData() {
      setSourceStatusLoading();

      const params = new URLSearchParams({
        bbox: GREECE_BBOX.join(','),
        days: String(getDays()),
        minMag: String(getMinMag())
      });

      const url = `${WORKER_ENDPOINT}?${params.toString()}`;
      let json;
      try {
        const res = await fetch(url, { cache: 'no-store' });
        json = await res.json();
      } catch (e) {
        console.error('Worker fetch failed', e);
        setSourceStatusErrorAll();
        return;
      }

      // Stats
      if (json?.stats) {
        if (statEq)    statEq.textContent    = json.stats.earthquakes ?? 0;
        if (statFi)    statFi.textContent    = json.stats.fires ?? 0;
        if (statFl)    statFl.textContent    = json.stats.floods ?? 0;
        if (statTotal) statTotal.textContent = json.stats.total ?? 0;
      }
      if (updatedAt) {
        updatedAt.textContent = json?.updated ? toLocal(json.updated) : '—';
      }

      // Source statuses
      if (json?.sources) applySourceStatuses(json.sources);

      // Draw layers
      const map = window.map;
      const eqLayer = window.earthquakesLayer;
      const fiLayer = window.firesLayer;
      const flLayer = window.floodsLayer;

      eqLayer.clearLayers();
      fiLayer.clearLayers();
      flLayer.clearLayers();

      const showQuakes = chkQuakes ? chkQuakes.checked : true;
      const showFires  = chkFires  ? chkFires.checked  : true;
      const showFloods = chkFloods ? chkFloods.checked : true;

      // Earthquakes
      (json?.data?.earthquakes || []).forEach(eq => {
        if (!showQuakes) return;
        if (typeof eq.lat !== 'number' || typeof eq.lon !== 'number') return;
        const m = Number(eq.mag) || 0;
        const marker = L.circleMarker([eq.lat, eq.lon], {
          radius: Math.max(4, Math.min(14, m * 2.5)),
          color: quakeColor(m),
          weight: 1,
          fillOpacity: 0.7
        });
        const srcs = Array.isArray(eq.sources) ? eq.sources.join(', ') : (eq._src || '');
        marker.bindPopup(`
          <div style="min-width:210px">
            <div><strong>M ${m.toFixed(1)}</strong> ${eq.place ? `— ${eq.place}` : ''}</div>
            <div>Depth: ${eq.depth ?? '—'} km</div>
            <div>Time: ${toLocal(eq.time)}</div>
            <div>Sources: ${srcs || '—'}</div>
            ${eq.url ? `<div><a href="${eq.url}" target="_blank" rel="noopener">Details</a></div>` : ''}
          </div>
        `);
        marker.addTo(eqLayer);
      });

      // Fires
      (json?.data?.fires || []).forEach(fi => {
        if (!showFires) return;
        if (typeof fi.lat !== 'number' || typeof fi.lon !== 'number') return;
        const marker = L.circleMarker([fi.lat, fi.lon], {
          radius: 5,
          color: '#d7191c',
          weight: 1,
          fillOpacity: 0.7
        });
        const srcs = Array.isArray(fi.sources) ? fi.sources.join(', ') : 'FIRMS';
        marker.bindPopup(`
          <div style="min-width:210px">
            <div><strong>Active Fire</strong></div>
            <div>Brightness: ${fi.bright ?? '—'}</div>
            <div>Confidence: ${fi.conf ?? '—'}</div>
            <div>Time: ${toLocal(fi.time)}</div>
            <div>Sources: ${srcs}</div>
          </div>
        `);
        marker.addTo(fiLayer);
      });

      // Floods
      (json?.data?.floods || []).forEach(fl => {
        if (!showFloods) return;
        if (typeof fl.lat !== 'number' || typeof fl.lon !== 'number') return;
        const marker = L.circleMarker([fl.lat, fl.lon], {
          radius: 6,
          color: '#2b83ba',
          weight: 1,
          fillOpacity: 0.6
        });
        const srcs = Array.isArray(fl.sources) ? fl.sources.join(', ') : 'GDACS';
        marker.bindPopup(`
          <div style="min-width:210px">
            <div><strong>Flood Event</strong></div>
            <div>Severity: ${fl.severity ?? fl.alert ?? '—'}</div>
            <div>Time: ${toLocal(fl.time)}</div>
            <div>Area: ${fl.place ?? fl.name ?? '—'}</div>
            <div>Sources: ${srcs}</div>
          </div>
        `);
        marker.addTo(flLayer);
      });

      // Fit once to available data
      if (!window.__didFitOnce) {
        const all = L.featureGroup([eqLayer, fiLayer, flLayer]);
        try {
          const b = all.getBounds();
          if (b.isValid()) {
            map.fitBounds(b.pad(0.1));
            window.__didFitOnce = true;
          }
        } catch {}
      }
    }

    function setSourceStatusLoading(){
      ['USGS','EMSC','NOA','FIRMS_MODIS','FIRMS_VIIRS','EFFIS','GDACS','CEMS'].forEach(n => {
        const e = statusEl(n); if (e) { e.textContent = '…'; e.classList.remove('ok','err'); e.classList.add('loading','pill'); }
      });
    }
    function setSourceStatusErrorAll(){
      ['USGS','EMSC','NOA','FIRMS_MODIS','FIRMS_VIIRS','EFFIS','GDACS','CEMS'].forEach(n => {
        const e = statusEl(n); if (e) { e.textContent = 'error'; e.classList.remove('ok','loading'); e.classList.add('err','pill'); }
      });
    }
    function applySourceStatuses(sources){
      sources.earthquakes && Object.entries(sources.earthquakes).forEach(([k,v]) => setStatus(`status-${k}`, v));
      sources.fires       && Object.entries(sources.fires).forEach(([k,v]) => setStatus(`status-${k}`, v));
      sources.floods      && Object.entries(sources.floods).forEach(([k,v]) => setStatus(`status-${k}`, v));
    }
    function setStatus(id, value){
      const e = el(`#${id}`) || el(`#${(id||'').toUpperCase()}`);
      if (!e) return;
      e.textContent = value;
      e.classList.remove('ok','err','loading');
      e.classList.add('pill');
      if (value === 'ok') e.classList.add('ok');
      else if (value === 'error') e.classList.add('err');
      else e.classList.add('loading');
    }

    // Wire controls
    const refreshBtn = el('#refresh-btn');
    refreshBtn && refreshBtn.addEventListener('click', loadData);
    [el('#time-period'), el('#min-mag'), el('#filter-quakes'), el('#filter-fires'), el('#filter-floods')]
      .forEach(c => c && c.addEventListener('change', loadData));

    // Kick off
    loadData();
    setInterval(loadData, AUTO_REFRESH_MS);
  })();
  </script>
</body>
</html>
