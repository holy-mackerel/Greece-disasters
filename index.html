<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Greece Official Disaster Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    :root{
      --bg:#10151b;--panel:#141b22;--muted:#9fb0c3;--text:#dce7f3;--accent:#38bdf8;
      --ok:#29cc7a;--warn:#f59e0b;--err:#ef4444;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    #app{display:grid;grid-template-columns:320px 1fr;height:100%;}
    aside{background:var(--panel);border-right:1px solid #0e1319;padding:12px 14px;overflow:auto}
    h1{font-size:16px;margin:0 0 6px}
    small{color:var(--muted)}
    .stat{background:#0f141a;border:1px solid #0c1117;border-radius:10px;padding:8px 10px;display:flex;flex-direction:column;gap:2px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin:8px 0 12px}
    .label{font-size:11px;color:var(--muted)}
    .value{font-size:20px;font-weight:700}
    .row{display:flex;align-items:center;gap:8px;margin:8px 0}
    select,button{background:#0f141a;border:1px solid #0c1117;color:var(--text);border-radius:8px;padding:6px 8px}
    button{cursor:pointer}
    .pill{display:inline-flex;align-items:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .ok{background:var(--ok)} .warn{background:var(--warn)} .err{background:var(--err)}
    #map{height:100%;width:100%}
    .footer{color:var(--muted);font-size:12px;margin-top:12px}
    .legend{font-size:12px;color:var(--muted);margin-top:8px}
    .sep{height:1px;background:#0e1319;margin:10px 0}
  </style>
</head>
<body>
<div id="app">
  <aside>
    <h1>Greece Official Disaster Map</h1>
    <small>Live earthquakes and fires in Greece. Data refreshes automatically every 10 minutes.</small>

    <div class="grid">
      <div class="stat"><div class="label">Earthquakes</div><div class="value" id="eqCount">0</div></div>
      <div class="stat"><div class="label">Fires</div><div class="value" id="fireCount">0</div></div>
      <div class="stat"><div class="label">Total</div><div class="value" id="totalCount">0</div></div>
      <div class="stat"><div class="label">Last updated</div><div class="value" id="lastUpdated">—</div></div>
    </div>

    <div class="row">
      <label class="pill"><input type="checkbox" id="toggleEq" checked /> Earthquakes</label>
      <label class="pill" style="margin-left:10px"><input type="checkbox" id="toggleFires" checked /> Fires</label>
    </div>

    <div class="row">
      <select id="days">
        <option value="1">24 hours</option>
        <option value="3">3 days</option>
        <option value="7" selected>7 days</option>
        <option value="30">30 days</option>
        <option value="90">3 months</option>
        <option value="365">Last year</option>
      </select>
      <select id="minmag" title="Earthquake minimum magnitude">
        <option value="2">M 2+</option>
        <option value="3" selected>M 3+</option>
        <option value="4">M 4+</option>
        <option value="5">M 5+</option>
      </select>
      <button id="refreshBtn" title="Refresh now">Refresh</button>
    </div>

    <div class="sep"></div>
    <div class="legend">
      <div class="pill"><span class="dot ok"></span> API reachable</div>
      <div class="pill"><span class="dot err"></span> API error</div>
      <div style="margin-top:8px">
        <div id="statusEq" class="pill"><span id="dotEq" class="dot warn"></span> Earthquakes API</div>
        <div id="statusFire" class="pill"><span id="dotFire" class="dot warn"></span> Fires API</div>
      </div>
    </div>

    <div class="sep"></div>
    <div class="footer">
      <b>Data Sources</b>
      <ul style="margin:6px 0 0 18px">
        <li>Earthquakes: USGS + EMSC (SeismicPortal)</li>
        <li>Fires: NASA FIRMS (VIIRS SNPP/NOAA-20, MODIS)</li>
      </ul>
      <div style="margin-top:8px">© Live, client-side map. Built with Leaflet.</div>
    </div>
  </aside>

  <div id="map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script>
  // -------- CONFIG --------
  // Your Worker base. You said these paths return data:
  //  - /api/earthquakes
  //  - /api/fires
  const API_BASE = 'https://greece-disasters.odysseas-3d2.workers.dev/api';

  // Greece bbox
  const BBOX = { south: 34.8, north: 41.8, west: 19.3, east: 29.6 };

  // -------- MAP --------
  const map = L.map('map', {
    minZoom: 5,
    maxZoom: 18,
  }).setView([38.5, 23.7], 6);

  L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution: '&copy; OpenStreetMap contributors' }
  ).addTo(map);

  // Layer groups
  const eqLayer = L.layerGroup().addTo(map);
  const fireLayer = L.layerGroup().addTo(map);

  // UI elements
  const eqCountEl = document.getElementById('eqCount');
  const fireCountEl = document.getElementById('fireCount');
  const totalCountEl = document.getElementById('totalCount');
  const lastUpdatedEl = document.getElementById('lastUpdated');
  const daysEl = document.getElementById('days');
  const minmagEl = document.getElementById('minmag');
  const toggleEqEl = document.getElementById('toggleEq');
  const toggleFiresEl = document.getElementById('toggleFires');
  const refreshBtn = document.getElementById('refreshBtn');
  const dotEq = document.getElementById('dotEq');
  const dotFire = document.getElementById('dotFire');

  toggleEqEl.addEventListener('change', () => {
    if (toggleEqEl.checked) eqLayer.addTo(map); else map.removeLayer(eqLayer);
  });
  toggleFiresEl.addEventListener('change', () => {
    if (toggleFiresEl.checked) fireLayer.addTo(map); else map.removeLayer(fireLayer);
  });

  refreshBtn.addEventListener('click', () => loadAll());

  daysEl.addEventListener('change', loadAll);
  minmagEl.addEventListener('change', loadAll);

  // -------- FETCH HELPERS --------
  function withinGreece(lat, lon){
    return lat >= BBOX.south && lat <= BBOX.north && lon >= BBOX.west && lon <= BBOX.east;
  }

  function setStatus(el, ok){
    el.classList.remove('ok','err','warn');
    el.classList.add(ok ? 'ok' : 'err');
  }

  async function fetchJSON(url){
    const r = await fetch(url, { cache: 'no-store' });
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  // -------- DRAW --------
  function drawEarthquakes(list){
    eqLayer.clearLayers();
    list.forEach(f=>{
      const { lat, lon, mag=0, depth, place, time, url, sources } = f;
      if(!withinGreece(lat, lon)) return;

      // style by magnitude
      const m = Number(mag)||0;
      const radius = 4 + m * 3; // scalable
      const color = m >= 5 ? '#ef4444' : m >= 4 ? '#f97316' : '#fde047'; // red→orange→yellow

      const circle = L.circleMarker([lat, lon], {
        radius, color, weight: 1, fillColor: color, fillOpacity: 0.7
      });

      const when = time ? new Date(time).toLocaleString() : '—';
      const html = `
        <b>M ${m.toFixed(1)}</b> &middot; depth ${depth ?? '—'} km<br/>
        <span>${place || ''}</span><br/>
        <small>${when}</small><br/>
        <small>Sources: ${Array.isArray(sources)?sources.join(', '):'—'}</small><br/>
        ${url ? `<a href="${url}" target="_blank">details</a>`:''}
      `;
      circle.bindPopup(html);
      circle.addTo(eqLayer);
    });
  }

  function drawFires(list){
    fireLayer.clearLayers();
    list.forEach(f=>{
      const { lat, lon, brightness, confidence, acq_date, acq_time, sources=[], verified } = f;
      if(!withinGreece(lat, lon)) return;

      const marker = L.circleMarker([lat,lon], {
        radius: 5,
        color: verified ? '#ef4444' : '#fb7185',
        weight: 1,
        fillColor: verified ? '#ef4444' : '#fb7185',
        fillOpacity: 0.7
      });

      const t = acq_date && acq_time ? `${acq_date} ${String(acq_time).padStart(4,'0').replace(/(\d{2})$/,':$1')} UTC` : '—';
      marker.bindPopup(`
        <b>Fire (VIIRS/MODIS)</b><br/>
        Brightness: ${brightness ?? '—'}<br/>
        Confidence: ${confidence ?? '—'}<br/>
        Time: ${t}<br/>
        Sources: ${sources.join(', ')}<br/>
        ${verified ? '<span style="color:#22c55e">Verified by 2+ products</span>' : ''}
      `);
      marker.addTo(fireLayer);
    });
  }

  // -------- LOAD --------
  async function loadAll(){
    const days = Number(daysEl.value);
    const minmag = Number(minmagEl.value);

    // endpoints your Worker exposes
    const eqUrl = `${API_BASE}/earthquakes?days=${encodeURIComponent(days)}&minmag=${encodeURIComponent(minmag)}`;
    const fireUrl = `${API_BASE}/fires?days=${encodeURIComponent(Math.min(days,10))}`;

    try{
      dotEq.classList.remove('ok','err'); dotEq.classList.add('warn');
      const eq = await fetchJSON(eqUrl); // { ok, data: [...] } or array
      const eqList = Array.isArray(eq) ? eq : (eq.data?.earthquakes || eq.data || []);
      drawEarthquakes(eqList);
      eqCountEl.textContent = eqList.filter(e=>withinGreece(e.lat,e.lon)).length;
      setStatus(dotEq,true);
    }catch(e){
      console.error('EQ fetch failed', e);
      setStatus(dotEq,false);
      drawEarthquakes([]);
      eqCountEl.textContent = '0';
    }

    try{
      dotFire.classList.remove('ok','err'); dotFire.classList.add('warn');
      const fr = await fetchJSON(fireUrl); // { ok, data: [...] } or array
      const fireList = Array.isArray(fr) ? fr : (fr.data || []);
      drawFires(fireList);
      fireCountEl.textContent = fireList.filter(f=>withinGreece(f.lat,f.lon)).length;
      setStatus(dotFire,true);
    }catch(e){
      console.error('Fires fetch failed', e);
      setStatus(dotFire,false);
      drawFires([]);
      fireCountEl.textContent = '0';
    }

    const total = Number(eqCountEl.textContent) + Number(fireCountEl.textContent);
    totalCountEl.textContent = total.toString();
    lastUpdatedEl.textContent = new Date().toLocaleTimeString();
  }

  // auto refresh every 10 minutes
  setInterval(loadAll, 10*60*1000);

  // initial
  loadAll();
</script>
</body>
</html>
