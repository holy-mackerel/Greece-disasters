<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Greece Official Disaster Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#0b1224;       /* deep slate */
      --panel-2:#0e1a34;
      --text:#e5e7eb;        /* gray-200 */
      --muted:#9ca3af;       /* gray-400 */
      --accent:#3b82f6;      /* blue-500 */
      --good:#22c55e;        /* green-500 */
      --bad:#ef4444;         /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    #app{display:grid;grid-template-columns:310px 1fr;height:100%}
    aside{
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border-right:1px solid #162447;
      padding:12px 12px 14px;
      overflow:auto;
    }
    h1{font-size:14px;margin:0 0 2px;font-weight:700}
    .sub{font-size:12px;color:var(--muted);margin-bottom:10px}
    .badge{display:inline-flex;align-items:center;gap:8px;margin-bottom:10px}
    .logo{width:26px;height:26px;border-radius:50%;background:#22335d;color:#cde3ff;display:inline-grid;place-items:center;font-weight:700}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:10px;margin-bottom:10px}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)}
    .kpi h3{font-size:11px;color:var(--muted);margin:0 0 6px;font-weight:600}
    .kpi .val{font-size:22px;font-weight:800}
    .pill{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:#475569;border:1px solid #1f2937}
    .dot.ok{background:var(--good)}
    .dot.err{background:var(--bad)}
    .dot.skip{background:#64748b}
    .section-title{font-size:11px;color:var(--muted);letter-spacing:.08em;font-weight:700;margin:8px 2px}
    .filters .row{margin:8px 0}
    label{font-size:12px;color:var(--muted)}
    select,button{
      width:100%;padding:9px 10px;border-radius:10px;border:1px solid #1f2a49;background:#0b1731;color:var(--text);outline:none;
    }
    button{background:linear-gradient(180deg,#2154c7,#1b47a8);border:1px solid #2b64dc}
    button:active{transform:translateY(1px)}
    .sources-note{font-size:11px;color:#8ea0bf}
    #map{height:100%;width:100%}
    .footer{font-size:11px;color:#7b8fb7;margin-top:8px}
    a{color:#93c5fd}
    .legend{font-size:11px;color:#bfd0ff}
  </style>
</head>
<body>
  <div id="app">
    <aside>
      <div class="badge">
        <div class="logo">GR</div>
        <div>
          <h1>Greece Official Disaster Map</h1>
          <div class="sub">Live earthquakes, fires, and floods for Greece<br/> (aggregated via Cloudflare Worker).</div>
        </div>
      </div>

      <div class="card">
        <div class="stats">
          <div class="kpi">
            <h3>EARTHQUAKES</h3>
            <div class="val" id="kpi-quakes">0</div>
          </div>
          <div class="kpi">
            <h3>FIRES</h3>
            <div class="val" id="kpi-fires">0</div>
          </div>
          <div class="kpi">
            <h3>FLOODS</h3>
            <div class="val" id="kpi-floods">0</div>
          </div>
          <div class="kpi">
            <h3>TOTAL</h3>
            <div class="val" id="kpi-total">0</div>
          </div>
        </div>
        <div class="footer">Updated: <span id="updated">â€”</span></div>
      </div>

      <div class="card">
        <div class="section-title">SOURCE STATUS</div>
        <div class="pill"><span>USGS</span><span class="dot" id="src-usgs"></span></div>
        <div class="pill"><span>EMSC</span><span class="dot" id="src-emsc"></span></div>
        <div class="pill"><span>NOA</span><span class="dot" id="src-noa"></span></div>
        <div class="pill"><span>NASA FIRMS (MODIS)</span><span class="dot" id="src-modis"></span></div>
        <div class="pill"><span>NASA FIRMS (VIIRS)</span><span class="dot" id="src-viirs"></span></div>
        <div class="pill"><span>EFFIS (Burnt Areas)</span><span class="dot" id="src-effis"></span></div>
        <div class="pill"><span>GDACS</span><span class="dot" id="src-gdacs"></span></div>
        <div class="pill"><span>Copernicus EMS</span><span class="dot" id="src-cems"></span></div>
      </div>

      <div class="card filters">
        <div class="section-title">FILTERS</div>
        <div class="row">
          <input type="checkbox" id="chk-quakes" checked> <label for="chk-quakes">Earthquakes</label>
          &nbsp;&nbsp;<input type="checkbox" id="chk-fires" checked> <label for="chk-fires">Fires</label>
          &nbsp;&nbsp;<input type="checkbox" id="chk-floods"> <label for="chk-floods">Floods</label>
        </div>
        <div class="row">
          <label for="period">Time period</label>
          <select id="period">
            <option value="1">Last 24 hours</option>
            <option value="3">Last 3 days</option>
            <option value="7" selected>Last 7 days</option>
            <option value="10">Last 10 days</option>
          </select>
        </div>
        <div class="row">
          <label for="minmag">Earthquakes: Min magnitude</label>
          <select id="minmag">
            <option value="0">M 0+</option>
            <option value="2" selected>M 2+</option>
            <option value="3">M 3+</option>
            <option value="4">M 4+</option>
            <option value="5">M 5+</option>
          </select>
        </div>
        <button id="btn-refresh">Refresh</button>
        <div class="footer">Data are aggregated by your Cloudflare Worker<br/>and refreshed automatically every 10 minutes.</div>
      </div>

      <div class="card">
        <div class="section-title">SOURCES</div>
        <div class="sources-note">
          Earthquakes: USGS, EMSC, NOA (if available).<br/>
          Fires: NASA FIRMS (MODIS &amp; VIIRS).<br/>
          Burnt areas: EFFIS (if configured).<br/>
          Floods: GDACS, Copernicus EMS (when available).<br/>
          Worker: <a id="worker-health" href="#" target="_blank">/health</a>
        </div>
      </div>

      <div class="legend card">
        Earthquakes: circle size by magnitude, color from yellow (low) to red (high).<br/>
        Fires: small orange/red dots (recent detections).<br/>
        Burnt areas: semi-transparent orange polygons.
      </div>
    </aside>
    <div id="map"></div>
  </div>

  <script>
    // ====== CONFIG ======
    // 1) Your MapTiler key (already provided earlier)
    const MAPTILER_KEY = "x1Q1SpeI9hPHQaeW1DEa";

    // 2) Your Cloudflare Worker base URL. Example:
    //    "https://greece-disasters.<your-subdomain>.workers.dev"
    // You can also pass it as a query param: ?worker=https://...workers.dev
    const urlParams = new URLSearchParams(location.search);
    const WORKER_BASE = urlParams.get("worker") || "https://greece-disasters.odysseas-3d2.workers.dev";

    // BBox for Greece
    const BOUNDS = [[34.8,19.3],[41.8,29.6]];

    // ====== MAP ======
    const map = L.map('map', {
      zoomControl: false
    }).fitBounds(BOUNDS, {padding:[10,10]});

    L.control.zoom({ position: 'topleft' }).addTo(map);

    const tiles = L.tileLayer(
      `https://api.maptiler.com/maps/streets/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &nbsp; | &nbsp; Tiles &copy; <a href="https://www.maptiler.com/">MapTiler</a>',
        maxZoom: 18
      }
    ).addTo(map);

    // Layers
    let quakeLayer = L.layerGroup().addTo(map);
    let fireLayer = L.layerGroup().addTo(map);
    let floodLayer = L.layerGroup().addTo(map);
    let burntLayer = L.layerGroup().addTo(map);

    // ====== UI HOOKS ======
    const el = (id) => document.getElementById(id);
    const kpiQuakes = el('kpi-quakes');
    const kpiFires  = el('kpi-fires');
    const kpiFloods = el('kpi-floods');
    const kpiTotal  = el('kpi-total');
    const updatedEl = el('updated');

    const srcUSGS = el('src-usgs');
    const srcEMSC = el('src-emsc');
    const srcNOA  = el('src-noa');
    const srcMODIS= el('src-modis');
    const srcVIIRS= el('src-viirs');
    const srcEFFIS= el('src-effis');
    const srcGDACS= el('src-gdacs');
    const srcCEMS = el('src-cems');

    const chkQuakes = el('chk-quakes');
    const chkFires  = el('chk-fires');
    const chkFloods = el('chk-floods');
    const periodSel = el('period');
    const minMagSel = el('minmag');
    const refreshBtn= el('btn-refresh');
    const healthLink = el('worker-health');

    healthLink.href = WORKER_BASE.replace(/\/+$/,'') + "/health";

    chkQuakes.addEventListener('change', drawAll);
    chkFires.addEventListener('change', drawAll);
    chkFloods.addEventListener('change', drawAll);
    periodSel.addEventListener('change', refresh);
    minMagSel.addEventListener('change', refresh);
    refreshBtn.addEventListener('click', refresh);

    let lastData = null;

    async function refresh(){
      const days = Number(periodSel.value || 7);
      const minMag = Number(minMagSel.value || 2);

      const url = `${WORKER_BASE.replace(/\/+$/,'')}/api?periodDays=${days}&minMag=${minMag}`;
      setStatusDotsLoading(true);

      try{
        const r = await fetch(url, { cache: 'no-store' });
        const data = await r.json();
        lastData = data;

        // KPIs
        kpiQuakes.textContent = data?.stats?.earthquakes ?? 0;
        kpiFires.textContent  = data?.stats?.fires ?? 0;
        kpiFloods.textContent = data?.stats?.floods ?? 0;
        kpiTotal.textContent  = data?.stats?.total ?? 0;
        updatedEl.textContent = data?.updated ? new Date(data.updated).toLocaleString() : 'â€”';

        // Source dots
        setDot(srcUSGS, statusToClass(data?.sources?.earthquakes?.USGS));
        setDot(srcEMSC, statusToClass(data?.sources?.earthquakes?.EMSC));
        setDot(srcNOA,  statusToClass(data?.sources?.earthquakes?.NOA));
        setDot(srcMODIS,statusToClass(data?.sources?.fires?.FIRMS_MODIS));
        setDot(srcVIIRS,statusToClass(data?.sources?.fires?.FIRMS_VIIRS));
        setDot(srcEFFIS,statusToClass(data?.burnt_areas?.EFFIS || data?.sources?.burnt_areas?.EFFIS));
        setDot(srcGDACS,statusToClass(data?.sources?.floods?.GDACS));
        setDot(srcCEMS, statusToClass(data?.sources?.floods?.CEMS));

        drawAll();
      }catch(err){
        console.error(err);
        setStatusDotsLoading(false);
        alert("Failed to fetch data from Worker. Check the Worker URL and CORS.");
      }
    }

    function setStatusDotsLoading(isLoading){
      const dots = [srcUSGS,srcEMSC,srcNOA,srcMODIS,srcVIIRS,srcEFFIS,srcGDACS,srcCEMS];
      dots.forEach(d => { if(!d) return; d.className = 'dot'; if(isLoading) d.style.opacity = 0.5; else d.style.opacity = 1; });
    }

    function statusToClass(s){
      if(!s) return 'skip';
      const v = String(s).toLowerCase();
      if(v.includes('ok') || v.includes('success')) return 'ok';
      if(v.includes('skip')) return 'skip';
      return 'err';
    }
    function setDot(el, cls){ if(!el) return; el.className = 'dot ' + (cls || 'skip'); }

    function drawAll(){
      quakeLayer.clearLayers();
      fireLayer.clearLayers();
      floodLayer.clearLayers();
      burntLayer.clearLayers();

      if(!lastData) return;

      if(chkQuakes.checked){
        (lastData.data?.earthquakes || []).forEach(q => {
          const m = q.mag ?? 0;
          const r = magToRadius(m);
          const c = magToColor(m);
          const marker = L.circleMarker([q.lat, q.lon], {
            radius: r, color: c, fillColor: c, fillOpacity: 0.35, weight: 1
          }).bindPopup(`
            <b>M ${fmt(m)} â€“ ${escapeHtml(q.place || 'â€”')}</b><br/>
            Depth: ${q.depth != null ? q.depth+' km' : 'â€”'}<br/>
            Time: ${q.time ? new Date(q.time).toLocaleString() : 'â€”'}<br/>
            Sources: ${(q.sources||[]).join(', ')}<br/>
            ${q.url ? `<a href="${q.url}" target="_blank">Details</a>` : ``}
          `);
          marker.addTo(quakeLayer);
        });
      }

      if(chkFires.checked){
        (lastData.data?.fires || []).forEach(f => {
          const c = fireColor(f.bright);
          const marker = L.circleMarker([f.lat, f.lon], {
            radius: 4, color: c, fillColor: c, fillOpacity: 0.6, weight: 0.5
          }).bindPopup(`
            <b>Fire detection</b><br/>
            Brightness: ${fmt(f.bright)}<br/>
            Confidence: ${escapeHtml(f.conf || 'â€”')}<br/>
            Time (UTC): ${f.time ? new Date(f.time).toLocaleString() : 'â€”'}<br/>
            Sources: ${(f.sources||[]).join(', ')}
          `);
          marker.addTo(fireLayer);
        });
      }

      // Floods placeholder: none yet.

      // Burnt areas polygons (optional)
      const polys = lastData.data?.burnt_areas || [];
      if(polys.length){
        polys.forEach(b => {
          if(!b.geom) return;
          const poly = L.geoJSON(b.geom, {
            style: {
              color:'#ea580c', weight:1, fillColor:'#f97316', fillOpacity:0.25
            }
          }).bindPopup(`
            <b>Burnt area</b><br/>
            Area (ha): ${fmt(b.areaHa)}<br/>
            Date: ${b.date ? new Date(b.date).toLocaleDateString() : 'â€”'}<br/>
            Source: EFFIS
          `);
          poly.addTo(burntLayer);
        });
      }
    }

    // Helpers
    function magToRadius(m){
      // Soft scale: M2=4px, M3=6px, M4=8px, M5=12px, M6+=16px
      return Math.max(3, Math.min(16, 2 + m*2));
    }
    function magToColor(m){
      // Yellow -> Orange -> Red
      if(m >= 5) return '#ef4444';
      if(m >= 4) return '#f59e0b';
      return '#facc15';
    }
    function fireColor(br){
      if(br == null) return '#fb923c';
      if(br >= 330) return '#ef4444';
      if(br >= 310) return '#f97316';
      return '#fb923c';
    }
    function fmt(v){
      if(v == null || Number.isNaN(Number(v))) return 'â€”';
      const n = Number(v);
      return Math.abs(n) >= 100 ? Math.round(n) : (Math.round(n*10)/10);
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g,(m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
    }

    // Auto-refresh every 10 minutes
    refresh();
    setInterval(refresh, 10*60*1000);
  </script>
</body>
</html>
