<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Greece Official Disaster Map</title>

<!-- Leaflet -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- PapaParse for CSV (kept for future, not required if Worker aggregates) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#0b1020; --panel:#121a33; --panel2:#0f1730; --muted:#9db0d0;
    --ok:#19c37d; --err:#ff6b6b; --warn:#ffb020; --text:#e8f0ff;
    --accent:#2b68ff;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  #app{display:grid;grid-template-columns:320px 1fr;height:100%}
  /* Sidebar */
  .sidebar{background:linear-gradient(180deg,var(--panel),var(--panel2));padding:14px 14px 18px;border-right:1px solid #1d2650;overflow:auto}
  .brand{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  .logo{width:32px;height:32px;border-radius:8px;background:#1e2a56;display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted);font-size:12px;line-height:1.35}
  .card{background:#0e1630;border:1px solid #1b2350;border-radius:14px;padding:10px;margin-bottom:10px}
  .h6{font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#bcd0ff;margin:2px 0 8px}
  .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .stat{background:#0a1229;border:1px solid #18204a;border-radius:12px;padding:10px}
  .stat .k{font-size:26px;font-weight:800}
  .rows{display:flex;flex-direction:column;gap:8px}
  .row{display:flex;align-items:center;justify-content:space-between;background:#0a1229;border:1px solid #18204a;border-radius:12px;padding:8px 10px}
  .pill{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px;border:1px solid #0003}
  .ok{background:var(--ok)}
  .err{background:var(--err)}
  .warn{background:var(--warn)}
  .controls{display:flex;flex-direction:column;gap:8px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  select,button,input[type="checkbox"]{accent-color:var(--accent)}
  select{width:100%;background:#09122a;border:1px solid #1a2550;color:var(--text);padding:8px 10px;border-radius:10px}
  .chk{display:flex;gap:8px;align-items:center}
  button{background:linear-gradient(180deg,#1f4bff,#1740e0);border:none;color:white;padding:10px;border-radius:12px;font-weight:700;cursor:pointer}
  button:disabled{opacity:.6;cursor:not-allowed}
  .small{font-size:11px;color:#8fa6d6}
  /* Map */
  #map{height:100%;width:100%}
  /* Toast */
  .toast{position:fixed;right:14px;bottom:14px;background:#101a36;border:1px solid #22306b;color:#dbe6ff;padding:10px 12px;border-radius:12px;box-shadow:0 8px 24px #0006;opacity:0;transform:translateY(8px);transition:all .25s}
  .toast.show{opacity:1;transform:translateY(0)}
  a, a:visited{color:#9ec2ff}
</style>
</head>
<body>
<div id="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">GR</div>
      <div>
        <div style="font-weight:800">Greece Official Disaster Map</div>
        <div class="muted">Live earthquakes, fires, and floods for Greece (aggregated via Cloudflare Worker).</div>
      </div>
    </div>

    <div class="card">
      <div class="h6">Live stats</div>
      <div class="stats">
        <div class="stat"><div class="small">EARTHQUAKES</div><div id="quakesCount" class="k">0</div></div>
        <div class="stat"><div class="small">FIRES</div><div id="firesCount" class="k">0</div></div>
        <div class="stat"><div class="small">FLOODS</div><div id="floodsCount" class="k">0</div></div>
        <div class="stat"><div class="small">TOTAL</div><div id="totalCount" class="k">0</div></div>
      </div>
      <div class="small" style="margin-top:6px">Updated: <span id="updatedAt">—</span></div>
    </div>

    <div class="card">
      <div class="h6">Source status</div>
      <div class="rows">
        <div class="row"><span>USGS</span><span><span id="usgsStatus" class="pill warn"></span></span></div>
        <div class="row"><span>EMSC</span><span><span id="emscStatus" class="pill warn"></span></span></div>
        <div class="row"><span>NOA</span><span><span id="noaStatus" class="pill warn"></span></span></div>
        <div class="row"><span>NASA FIRMS (MODIS)</span><span><span id="firmsModisStatus" class="pill warn"></span></span></div>
        <div class="row"><span>NASA FIRMS (VIIRS)</span><span><span id="firmsViirsStatus" class="pill warn"></span></span></div>
        <div class="row"><span>EFFIS</span><span><span id="effisStatus" class="pill warn"></span></span></div>
        <div class="row"><span>GDACS</span><span><span id="gdacsStatus" class="pill warn"></span></span></div>
        <div class="row"><span>Copernicus EMS</span><span><span id="cemsStatus" class="pill warn"></span></span></div>
      </div>
    </div>

    <div class="card">
      <div class="h6">Filters</div>
      <div class="controls">
        <div class="inline">
          <label class="chk"><input id="chkQuakes" type="checkbox" checked>Earthquakes</label>
          <label class="chk"><input id="chkFires" type="checkbox" checked>Fires</label>
          <label class="chk"><input id="chkFloods" type="checkbox" checked>Floods</label>
        </div>
        <select id="timeRange">
          <option value="1">Last 24 hours</option>
          <option value="3">Last 3 days</option>
          <option value="7">Last 7 days</option>
          <option value="10">Last 10 days (max)</option>
        </select>
        <select id="minMag">
          <option value="2">Earthquakes: M 2+</option>
          <option value="3">Earthquakes: M 3+</option>
          <option value="4">Earthquakes: M 4+</option>
          <option value="5">Earthquakes: M 5+</option>
        </select>
        <button id="refreshBtn">Refresh</button>
        <div class="small">Data are aggregated by your Cloudflare Worker and refreshed automatically every 10 minutes.</div>
      </div>
    </div>

    <div class="card">
      <div class="h6">Sources</div>
      <div class="small">
        Earthquakes: USGS, EMSC, NOA (if available). Fires: NASA FIRMS (MODIS &amp; VIIRS), EFFIS. Floods: GDACS, Copernicus EMS (if available).<br/>
        <br/>Worker: <a href="https://greece-disasters.odysseas-3d2.workers.dev/health" target="_blank">/health</a>
      </div>
    </div>

  </aside>

  <main id="map"></main>
</div>

<div id="toast" class="toast"></div>

<script>
/* =======================
   CONFIG
   ======================= */
const MAPTILER_KEY = "x1Q1SpeI9hPHQaeW1DEa";
const WORKER_BASE  = "https://greece-disasters.odysseas-3d2.workers.dev";
const API_URL      = WORKER_BASE + "/api";
const WARM_URL     = WORKER_BASE + "/warm";

// Greece bounds
const GR_BOUNDS = [[34.8,19.3],[41.8,29.6]];

/* =======================
   MAP
   ======================= */
const map = L.map('map', {zoomControl:true,minZoom:5,maxZoom:17});
map.fitBounds(GR_BOUNDS);

const tiles = L.tileLayer(
  `https://api.maptiler.com/maps/streets-v2/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
  { attribution:'&copy; <a href="https://www.maptiler.com/copyright/">MapTiler</a> &copy; OpenStreetMap contributors' }
).addTo(map);

const quakesLayer = L.layerGroup().addTo(map);
const firesLayer  = L.layerGroup().addTo(map);
const floodsLayer = L.layerGroup().addTo(map);

/* =======================
   UI HELPERS
   ======================= */
const $ = sel => document.querySelector(sel);
const ids = id => document.getElementById(id);

function toast(msg, ms=2600){
  const t = ids('toast'); t.textContent = msg; t.classList.add('show');
  clearTimeout(toast._t); toast._t = setTimeout(()=>t.classList.remove('show'), ms);
}

function setSourceStatus(mapStatus){
  // Earthquakes
  badge('usgsStatus', mapStatus?.earthquakes?.USGS);
  badge('emscStatus', mapStatus?.earthquakes?.EMSC);
  badge('noaStatus',  mapStatus?.earthquakes?.NOA);
  // Fires
  badge('firmsModisStatus', mapStatus?.fires?.FIRMS_MODIS);
  badge('firmsViirsStatus', mapStatus?.fires?.FIRMS_VIIRS);
  badge('effisStatus',       mapStatus?.fires?.EFFIS);
  // Floods
  badge('gdacsStatus', mapStatus?.floods?.GDACS);
  badge('cemsStatus',  mapStatus?.floods?.CEMS);
}

function badge(id, status){
  const el = ids(id); if(!el) return;
  el.classList.remove('ok','err','warn');
  if(status === 'ok') el.classList.add('ok');
  else if(status === 'error') el.classList.add('err');
  else el.classList.add('warn'); // loading/skipped/unknown
}

function setStats(stats, updated){
  ids('quakesCount').textContent = stats?.earthquakes ?? 0;
  ids('firesCount').textContent  = stats?.fires ?? 0;
  ids('floodsCount').textContent = stats?.floods ?? 0;
  ids('totalCount').textContent  = stats?.total ?? 0;
  ids('updatedAt').textContent   = updated ? new Date(updated).toLocaleString() : '—';
}

function getFilters(){
  const periodDays = Math.min(10, Number(ids('timeRange').value||1));
  const minMag = Number((ids('minMag').value||'2').replace(/\D/g,''))||2;
  return {
    showQuakes: ids('chkQuakes').checked,
    showFires:  ids('chkFires').checked,
    showFloods: ids('chkFloods').checked,
    periodDays, minMag
  };
}

/* =======================
   DRAW FUNCTIONS
   ======================= */
function quakeColor(m){
  if (m>=5) return '#ff3b3b';
  if (m>=4) return '#ff7b2f';
  if (m>=3) return '#ffb32a';
  return '#ffe14d';
}
function drawEarthquakes(arr){
  quakesLayer.clearLayers();
  arr.forEach(f=>{
    const m = Math.max(2, Number(f.mag||0));
    const c = quakeColor(m);
    const r = 2 + m * 2.2;
    const lm = L.circleMarker([f.lat, f.lon], {radius:r,color:c,weight:1,fillColor:c,fillOpacity:.35});
    const when = f.time ? new Date(f.time).toLocaleString() : '—';
    const src = Array.isArray(f.sources)? f.sources.join(', ') : (f._src || '—');
    const place = f.place || '—';
    const depth = (f.depth!=null)? `${Math.abs(f.depth)} km` : '—';
    const link = f.url ? `<a href="${f.url}" target="_blank">details</a>` : '';
    lm.bindPopup(`<b>Magnitude ${m.toFixed(1)}</b><br>Depth: ${depth}<br>${place}<br>${when}<br><small>Sources: ${src} ${link?('· '+link):''}</small>`);
    quakesLayer.addLayer(lm);
  });
}

function drawFires(arr){
  firesLayer.clearLayers();
  arr.forEach(p=>{
    const when = p.time ? new Date(p.time).toLocaleString() : '—';
    const conf = (p.conf || '').toString().toUpperCase();
    const lm = L.circleMarker([p.lat, p.lon], {radius:4,color:'#ff5757',fillColor:'#ff5757',fillOpacity:.55,weight:1});
    lm.bindPopup(`<b>Active Fire</b><br>Brightness: ${p.bright ?? '—'}<br>Confidence: ${conf || '—'}<br>${when}<br><small>Source: FIRMS</small>`);
    firesLayer.addLayer(lm);
  });
}

function drawFloods(arr){
  floodsLayer.clearLayers();
  arr.forEach(p=>{
    const when = p.time ? new Date(p.time).toLocaleString() : '—';
    const sev = p.severity || p.alert || '—';
    const name = p.name || p.place || 'Flood';
    const lm = L.circleMarker([p.lat, p.lon], {radius:5,color:'#3aa0ff',fillColor:'#3aa0ff',fillOpacity:.45,weight:1});
    lm.bindPopup(`<b>${name}</b><br>Severity: ${sev}<br>${when}<br><small>Sources: ${(p.sources||[]).join(', ')||'—'}</small>`);
    floodsLayer.addLayer(lm);
  });
}

/* =======================
   DATA FETCH
   ======================= */
async function fetchAggregated(periodDays, minMag){
  const url = `${API_URL}?periodDays=${encodeURIComponent(periodDays)}&minMag=${encodeURIComponent(minMag)}&_=${Date.now()}`;
  const res = await fetch(url, {cache:'no-store',headers:{'accept':'application/json'}});
  if(!res.ok) throw new Error(`Worker ${res.status}`);
  const json = await res.json();
  if(!json?.ok || !json.data) throw new Error('Unexpected Worker payload');
  return json;
}

async function reload(){
  const btn = ids('refreshBtn'); btn.disabled = true; btn.textContent = 'Loading…';
  try{
    const f = getFilters();
    const payload = await fetchAggregated(f.periodDays, f.minMag);

    // Stats & status badges
    setStats(payload.stats, payload.updated);
    setSourceStatus(payload.sources);

    // Draw layers based on toggles
    (f.showQuakes ? drawEarthquakes : ()=>quakesLayer.clearLayers())(payload.data.earthquakes || []);
    (f.showFires  ? drawFires      : ()=>firesLayer.clearLayers())  (payload.data.fires || []);
    (f.showFloods ? drawFloods     : ()=>floodsLayer.clearLayers()) (payload.data.floods || []);

    // Fit bounds if anything to show
    const allPts = []
      .concat((payload.data.earthquakes||[]).map(p=>[p.lat,p.lon]))
      .concat((payload.data.fires||[]).map(p=>[p.lat,p.lon]))
      .concat((payload.data.floods||[]).map(p=>[p.lat,p.lon]));
    if(allPts.length){ map.fitBounds(allPts, {padding:[40,40]}); }
    else { map.fitBounds(GR_BOUNDS); }

  }catch(err){
    console.error(err);
    toast('Failed to load data from Worker');
  }finally{
    btn.disabled = false; btn.textContent = 'Refresh';
  }
}

/* =======================
   WIRING
   ======================= */
ids('refreshBtn').addEventListener('click', reload);
ids('timeRange').addEventListener('change', reload);
ids('minMag').addEventListener('change', reload);
ids('chkQuakes').addEventListener('change', reload);
ids('chkFires').addEventListener('change', reload);
ids('chkFloods').addEventListener('change', reload);

// Pre-warm the Worker (non-blocking)
try { fetch(WARM_URL, {mode:'no-cors'}); } catch{}

// Initial load + auto-refresh every 10 minutes
document.addEventListener('DOMContentLoaded', reload);
setInterval(reload, 10 * 60 * 1000);
</script>
</body>
</html>
